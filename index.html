<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MicroERP Repuestos | Versión Lite (HTML/CSS/JS)</title>
  <!--
    Proyecto: MicroERP para microempresa de repuestos automotrices
    Requerimientos del usuario:
      - Sin frameworks ni librerías externas; solo HTML, CSS y JS puro (para VSCode)
      - Secciones:
          1) Principal (Dashboard + Historial de transacciones)
          2) Inventario de repuestos (código, nombre, cantidad, P. costo, costo total, P. venta, ganancia por venta)
          3) CRM y Ventas (Contactos, Empresas, Cotizaciones/Facturas)
          4) Proyectos y Tareas (Proyectos, Tareas dependientes, Calendario modificable, Gantt dependiente)
          5) Apuntes (tipo intranet con páginas a la izquierda y editor a la derecha)
          6) RR.HH. (Empleados, Ausencias, Turnos, Evaluaciones, Organigrama, Onboarding checklist)
          7) Exportador (panel para imprimir/exportar a PDF cada sección y exportar imágenes de gráficos)
      - Interactividad esencial: añadir / eliminar elementos, navegación, vista ordenada
      - Gráficos sin librerías (canvas 2D)
      - Persistencia local mínima con localStorage (sin APIs)
      - Colores distintos al proyecto anterior; estética limpia, simple, espaciosa
      - Entregable en bloques ~500 líneas

    Bloque 1 (~1–500):
      - Estructura general, estilos base, layout sidebar + topbar
      - Sección Principal con tarjetas resumen y gráfico de ingresos (línea)
      - Historial de transacciones con tabla + formulario básico (agregar/eliminar)
      - Infraestructura de router, store (localStorage), utilidades de fecha
      - Sistema simple de exportación por impresión de sección
  -->
  <style>
    
    :root{
      --bg:#0f1720;          /* azul petróleo muy oscuro */
      --bg-soft:#121c26;     /* fondo tarjetas oscuro */
      --panel:#0b141d;       /* sidebar/topbar */
      --pri:#3dd6d0;         /* turquesa vivo */
      --pri-2:#7ef5f0;       /* turquesa claro */
      --sec:#eab308;         /* dorado */
      --muted:#7a8a9a;       /* texto secundario */
      --ok:#22c55e;          /* verde */
      --warn:#f59e0b;        /* ámbar */
      --bad:#4233cc;         /* rojo */
      --white:#eef2f7;       /* texto base */
      --grid:#213140;        /* color rejilla charts */
      --shadow: 0 8px 20px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
  margin:0; background:var(--bg); color:var(--white);
  font: 14.5px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  position: relative;
  overflow-x: hidden;
  
  display: grid;
  grid-template-columns: var(--sidebar-w) 1fr;
  grid-template-rows: auto 1fr;
  grid-template-areas:
    "sidebar topbar"
    "sidebar main";

}
    /* Sidebar */
    aside#sidebar{
      grid-area:sidebar; background:var(--panel); border-right:1px solid rgba(255,255,255,.05);
      display:flex; flex-direction:column; gap:12px; padding:16px; overflow:auto;
    }
    .brand{display:flex; align-items:center; gap:10px; padding:8px 6px;}
    .brand-logo{width:32px; height:32px; border-radius:10px; background:linear-gradient(135deg,var(--pri),var(--sec)); box-shadow:var(--shadow)}
    .brand h1{font-size:16px; margin:0; letter-spacing:.3px}
    nav .nav-section-title{margin:14px 8px 6px; color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.12em}
    .nav{
      display:flex; flex-direction:column; gap:4px;
    }
    .nav button{
      all:unset; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer;
      color:var(--white); border:1px solid transparent;
    }
    .nav button:hover{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.06)}
    .nav button.active{background:linear-gradient(135deg, rgba(61,214,208,.15), rgba(234,179,8,.12)); border-color:rgba(61,214,208,.3)}
    .nav .ico{width:18px; height:18px; display:inline-block; border-radius:4px; background:linear-gradient(135deg,var(--pri),var(--pri-2)); opacity:.85}

    .sidebar-foot{
      margin-top:auto; display:flex; flex-direction:column; gap:8px; color:var(--muted); font-size:12px; opacity:.9
    }

    /* Topbar */
    header#topbar{
      grid-area:topbar; background:var(--panel); border-bottom:1px solid rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 16px; position:sticky; top:0; z-index:3;
    }
    .top-left{display:flex; align-items:center; gap:10px}
    .crumb{font-weight:600}
    .search{position:relative}
    .search input{
      background:var(--bg-soft); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:9px 12px; color:var(--white); min-width:260px;
      outline:none;
    }
    .search .hint{position:absolute; right:8px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:12px}

    /* Main */
    main#main{
      grid-area:main; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:18px;
    }

    /* Utility */
    .row{display:grid; gap:16px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:1fr 1fr 1fr}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{
      background:var(--bg-soft); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    .card h3{margin:0 0 10px 0; font-size:15px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:20px; background:rgba(255,255,255,.06); font-size:12px}
    .btn{
      all:unset; display:inline-flex; align-items:center; gap:8px; background:linear-gradient(135deg,var(--pri),var(--pri-2));
      color:#0b1218; font-weight:700; padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .btn.ghost{background:transparent; color:var(--white); border:1px solid rgba(255,255,255,.12)}
    .btn.warn{background:linear-gradient(135deg, var(--warn), #f8d36b)}
    .btn.bad{background:linear-gradient(135deg, var(--bad), #ff8c8c)}
    .btn.ok{background:linear-gradient(135deg, var(--ok), #86efac)}

    table{width:100%; border-collapse:collapse; background:transparent}
    th, td{padding:10px 8px; border-bottom:1px dashed rgba(255,255,255,.08); text-align:left}
    thead th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.08em}
    tbody tr:hover{background:rgba(255,255,255,.03)}

    input[type="text"], input[type="number"], input[type="date"], select, textarea{
      width:100%; padding:9px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0d1721; color:var(--white);
      outline:none;
    }
    textarea{min-height:120px; resize:vertical}
    form .row{grid-template-columns:repeat(4, 1fr)}
    form .row .span-2{grid-column:span 2}
    form .row .span-3{grid-column:span 3}
    .right{justify-self:end}

    /* KPI Cards */
    .kpi{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .kpi .value{font-size:26px; font-weight:800}
    .kpi .trend{font-size:12px}

    /* Chart Canvas container */
    .chart-wrap{position:relative; height:260px}
    canvas.chart{width:100%; height:260px; display:block; background:linear-gradient(180deg, rgba(61,214,208,.07), rgba(61,214,208,0)); border-radius:12px;}

    /* Tabs (para subsecciones internas) */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .tabs button{all:unset; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); cursor:pointer}
    .tabs button.active{background:rgba(61,214,208,.12); border-color:rgba(61,214,208,.4)}

    /* Print styles para exportar por sección */
    @media print{
      body{grid-template-columns:1fr; grid-template-rows:1fr; grid-template-areas:"main"}
      #sidebar, #topbar{display:none}
      main#main{padding:0}
      .card{page-break-inside:avoid}
    }
    

/* Sidebar desplazable parcialmente */


/* Mejora visual para el botón Cancelar */
button.btn.ghost[value="cancel"] {
  color: #eab308 !important;         /* Amarillo dorado */
  border: 1.5px solid #eab308 !important;
  background: rgba(234,179,8,0.08) !important;
  font-weight: 700;
  opacity: 1 !important;
  transition: background 0.2s, color 0.2s;
}
button.btn.ghost[value="cancel"]:hover {
  background: #eab308 !important;
  color: #0f1720 !important;
  border-color: #eab308 !important;
}

dialog, dialog form {
  background: #182532 !important;
  color: var(--white) !important;
  border-radius: 18px !important;
  border: none !important;
  box-shadow: 0 8px 32px rgba(0,0,0,0.35);
}
dialog form {
  box-shadow: none !important;
}
dialog h3 {
  color: var(--pri);
}
/* Agrega separación entre KPIs y el contenido central */

#kpiRow {
  margin-bottom: 18px;
}

/* Sidebar base */
#sidebar {
  width: 220px;
  transition: margin-left 0.3s ease;
  position: relative; /* para que el botón quede dentro */
  width: var(--sidebar-w);
  transition: width .28s ease, padding .28s ease;
  overflow: hidden;      /* oculta texto cuando colapse */
  z-index: 2;
}
/* Sidebar colapsado */
#sidebar.collapsed {
  margin-left: -180px; /* ajusta este valor a tu gusto */
}

/* Botón de flecha */
#toggleSidebar {
  
  
  width: 24px;
  height: 24px;
  border-radius: 50%;
  position:absolute; top:10px; right:20px;
  cursor:pointer; transition: transform .28s ease;
}

/* Flecha rota cuando está colapsado */
#sidebar.collapsed #toggleSidebar {
  transform: rotate(180deg);
}
:root{
  --sidebar-w: 220px;   /* ancho normal */
  --sidebar-w-mini: 56px; /* ancho colapsado */
}
aside#sidebar{ grid-area: sidebar; }
header#topbar{ grid-area: topbar; }
main#main{     grid-area: main; }
/* === Sidebar expandible con GRID (main se adapta solo) === */
:root{
  --sidebar-w: 220px;        /* ancho normal */
  --sidebar-w-mini: 56px;    /* ancho colapsado (solo iconos) */
}

/* 1) Layout principal en grid: sidebar + (topbar arriba / main abajo) */
body{
  display: grid;
  grid-template-columns: auto 1fr;           /* el ancho del sidebar lo define #sidebar */
  grid-template-rows: auto 1fr;
  grid-template-areas:
    "sidebar topbar"
    "sidebar main";
}

/* Ya tienes estas áreas; las repetimos por claridad */
aside#sidebar{ grid-area: sidebar; }
header#topbar{ grid-area: topbar; }
main#main{     grid-area: main; }

/* 2) Sidebar: su ancho controla la columna 1 del grid */
#sidebar{
  width: var(--sidebar-w);
  transition: width .28s ease, padding .28s ease;
  overflow: hidden;                 /* oculta texto al colapsar */
  position: relative;
  z-index: 2;
}

/* Botón flecha (sigue igual) */
#toggleSidebar{
  position: absolute;
  top: 10px;
  right: 20px;
  width: 24px; height: 24px; border-radius: 50%;
  cursor: pointer;
  transition: transform .28s ease;
}

/* 3) Estado colapsado: estrechamos el sidebar → la columna 1 se hace mini
      y el área derecha (topbar + main) se expande automáticamente */
body.sidebar-collapsed #sidebar{
  width: var(--sidebar-w-mini);
  padding-left: 10px; padding-right: 10px;
}

/* 4) Ocultar textos en el menú cuando está colapsado (dejamos iconos) */
body.sidebar-collapsed #sidebar .brand h1{ display:none; }
body.sidebar-collapsed #sidebar .nav button{
  padding:10px;               /* más compacto */
  gap:0;                      /* sin separación */
  font-size: 0;               /* oculta el texto del botón */
}
body.sidebar-collapsed #sidebar .nav .ico{
  margin:0;                   /* centra el icono */
}

/* 5) Rotación de la flecha en modo colapsado */
body.sidebar-collapsed #toggleSidebar{ transform: rotate(180deg); }
  </style>
</head>
<body>

    <!-- Dialogo y formulario para añadir/editar repuesto -->
<dialog id="invDialog">
  <form id="invForm" method="dialog" style="min-width:420px">
    <h3 id="invDialogTitle">Nuevo repuesto</h3>
    <div class="row" style="grid-template-columns:repeat(2,1fr)">
      <div><label>Código</label><input name="codigo" required></div>
      <div><label>Nombre</label><input name="nombre" required></div>
      <div><label>Cantidad</label><input name="cantidad" type="number" min="0" required></div>
      <div><label>PU Costo</label><input name="puc" type="number" step="0.01" min="0" required></div>
      <div><label>PU Venta</label><input name="puv" type="number" step="0.01" min="0" required></div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
      <button class="btn ghost" value="cancel">Cancelar</button>
      <button class="btn" value="confirm">Guardar</button>
    </div>
  </form>
</dialog>
  <!-- ===================== SIDEBAR ===================== -->
  <aside id="sidebar">
  <button id="toggleSidebar" style="margin-bottom:12px; align-self:flex-end" aria-label="Colapsar menú">
    <span id="toggleIcon" style="font-size:20px;">⮜</span>
  </button>
  <div class="brand">
    <div class="brand-logo" aria-hidden="true"></div>
    <h1>MicroERP </h1>
  </div>

    <nav>
      <div class="nav-section-title">Navegación</div>
      <div class="nav">
        <button data-route="principal" class="active"><span class="ico"></span> Principal</button>
        <button data-route="inventario"><span class="ico"></span> Inventario</button>
        <button data-route="crm"><span class="ico"></span> CRM & Ventas</button>
        <button data-route="proyectos"><span class="ico"></span> Proyectos & Tareas</button>
        <button data-route="apuntes"><span class="ico"></span> Apuntes</button>
        <button data-route="rrhh"><span class="ico"></span> RR.HH.</button>
        <button data-route="export"><span class="ico"></span> Exportar</button>
        <button data-route="soporte"><span class="ico"></span> Soporte</button>
      </div>
    </nav>

    <div class="sidebar-foot">
      <div>Versión: <b>Lite 1.0</b></div>
      <div>Almacenamiento: <span id="storageHint">localStorage</span></div>
    </div>
  </aside>
<div id="sidebarOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.18); z-index:9"></div>
  <!-- ===================== TOPBAR ===================== -->
  <header id="topbar">
    <div class="top-left">
      <div class="crumb">Sección: <span id="crumb">Principal</span></div>
      <span class="pill">Hoy: <span id="today"></span></span>
    </div>
    <div class="top-right">
      <div class="search">
        <input id="globalSearch" placeholder="Buscar en tablas…" />
        <span class="hint">CTRL + K</span>
      </div>
    </div>
  </header>

  <!-- ===================== MAIN ===================== -->
  <main id="main">

    <!-- ====== PRINCIPAL (Dashboard + Historial) ====== -->
    <section class="route" id="route-principal">
      <div class="row cols-4" id="kpiRow">
        <div class="card kpi">
          <div>
            <div class="muted">Ingresos (15 días)</div>
            <div class="value" id="kpiIngresos">S/ 0</div>
            <div class="trend" id="kpiIngresosTrend">—</div>
          </div>
          <span class="pill">Objetivo: S/ <span id="kpiGoal1">5000</span></span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Costos (15 días)</div>
            <div class="value" id="kpiCostos">S/ 0</div>
            <div class="trend" id="kpiCostosTrend">—</div>
          </div>
          <span class="pill">Margen prom.: <span id="kpiMargen">0%</span></span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Ganancia Neta (15 días)</div>
            <div class="value" id="kpiGanancia">S/ 0</div>
            <div class="trend" id="kpiGananciaTrend">—</div>
          </div>
          <span class="pill ok">Meta: <span id="kpiGoal2">S/ 3000</span></span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Tareas pendientes</div>
            <div class="value" id="kpiTareas">0</div>
            <div class="trend" id="kpiTareasTrend">—</div>
          </div>
          <span class="pill warn">Proyectos activos: <span id="kpiProyectos">0</span></span>
        </div>
      </div>

      <div class="row cols-2">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
            <h3>Ingresos por ventas</h3>
            <div>
              <select id="chartPeriod">
                <option value="15">Últimos 15 días</option>
                <option value="month">Mes…</option>
                <option value="year">Año actual</option>
              </select>
              <select id="chartMonth" style="display:none"></select>
              <button class="btn ghost" id="downloadChartBtn">Descargar imagen</button>
            </div>
          </div>
          <div class="chart-wrap">
            <canvas id="salesChart" class="chart" width="900" height="260" aria-label="Gráfico de ingresos"></canvas>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
            <h3>Resumen rápido</h3>
            <button class="btn" onclick="printSection('route-principal')">Exportar PDF</button>
          </div>
          <ul class="muted" id="quickSummary" style="margin:0; padding-left:18px; line-height:1.9">
            <li>Top producto vendido (15 días): <b id="sumTopItem">—</b></li>
            <li>Cliente con más compras (15 días): <b id="sumTopCliente">—</b></li>
            <li>Ticket promedio: <b id="sumTicket">—</b></li>
            <li>Días con ventas: <b id="sumDiasVenta">0</b> / <span id="sumBaseDias">15</span></li>
          </ul>
        </div>
      </div>

      


          <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px">
            <h3>Historial de transacciones</h3>
  <button class="btn" id="addTxnBtn">Añadir</button>
  <select id="txTipoFilter" style="padding:8px 12px; border-radius:10px;">
    <option value="">Todos los tipos</option>
    <option value="ingreso">Ingresos empresa</option>
    <option value="gasto">Gastos empresa</option>
    <option value="reinversion">Reinversión capital</option>
  </select>
    <button class="btn ok" id="saveAllBtn">Guardar todo</button>
  <button class="btn ok" id="backupBtn">Download backup</button>
  <button class="btn ok" id="restoreBtn">Restore backup</button>
<input type="file" id="restoreFile" accept=".json" style="display:none">
<button class="btn ghost" onclick="exportTableCSV('txTable','transacciones.csv')">Exportar CSV</button>
  <button class="btn ghost" onclick="printSection('route-principal')">Exportar PDF</button>
</div>

</div>
        </div>
    
        <!-- Formulario modal sencillo -->
        <dialog id="txnDialog">
          <form id="txnForm" method="dialog">
            <h3>Nueva transacción</h3>
            <div class="row" style="grid-template-columns:repeat(3,1fr)">
              <div>
                <label>Fecha</label>
                <input type="date" name="fecha" required />
              </div>
              <div>
                <label>Cliente</label>
                <input type="text" name="cliente" placeholder="Nombre del cliente" required />
              </div>
              <div>
                <label>Estado</label>
                <select name="estado">
                  <option>Pendiente</option>
                  <option>Cancelado</option>
                  <option>Completado</option>
                </select>
              </div>
              <div class="span-3">
                <label>Descripción</label>
                <input type="text" name="descripcion" placeholder="Detalle de la transacción" />
              </div>
              <div>
                <label>Total (S/)</label>
                <input type="number" name="total" step="0.01" required />
              </div>
              <div>
                <label>¿Pagado?</label>
                <select name="pagado">
                  <option value="si">Sí</option>
                  <option value="no">No</option>
                </select>
              </div>
              <div>
  <label>Tipo</label>
  <select name="tipo" required>
    <option value="ingreso">Ingresos empresa</option>
    <option value="gasto">Gastos empresa</option>
    <option value="reinversion">Reinversión capital</option>
  </select>
</div>
              <div>
                <label># Número</label>
                <input type="text" name="numero" placeholder="AUTO si se deja vacío" />
              </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
              <button class="btn ghost" value="cancel">Cancelar</button>
              <button class="btn" value="confirm" type="submit">Guardar</button>
            </div>
          </form>
        </dialog>

        <div id="txSection">
          <table id="txTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Descripción</th>
                <th>Total (pagado)</th>
                <th>Estado</th>
                <th>Tipo</th> <!-- nueva columna -->
                <th>Acción</th>
              </tr>
            </thead>
            <tbody id="txBody">
              <!-- filas dinámicas -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ====== PLACEHOLDERS de otras rutas (se completan en siguientes bloques) ====== -->
    <section class="route" id="route-inventario" style="display:none">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <h3>Inventario de Repuestos</h3>
          <div style="display:flex; gap:8px">
            <button class="btn ok" id="addItemBtn">Añadir repuesto</button>
            <button class="btn ghost" onclick="exportTableCSV('invTable','inventario.csv')">Exportar CSV</button>
            <button class="btn ghost" onclick="printSection('route-inventario')">Exportar PDF</button>
          </div>
        </div>
        <p class="muted">*Campo mínimo viable implementado en el siguiente bloque.</p>
        <table id="invTable">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>PU Costo</th>
              <th>Costo Total</th>
              <th>PU Venta</th>
              <th>Ganancia por venta</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Visualizaciones</h3>
        <div class="row cols-2">
          <div class="chart-wrap"><canvas id="invBarChart" class="chart" width="900" height="260"></canvas></div>
          <div class="chart-wrap"><canvas id="invValChart" class="chart" width="900" height="260"></canvas></div>
        </div>
      </div>
    </section>

    <section class="route" id="route-crm" style="display:none">
      <div class="card">
        <h3>CRM & Ventas</h3>
        <p class="muted">Contactos, Empresas, Cotizaciones/Facturas (se implementará en el siguiente bloque).</p>
        <div class="tabs">
          <button class="active" data-crm-tab="contactos">Contactos</button>
          <button data-crm-tab="empresas">Empresas</button>
          <button data-crm-tab="docs">Cotizaciones / Facturas</button>
        </div>
        <div id="crmTabContent" class="card" style="background:transparent; border:none; padding:0">
          <!-- contenido tab dinámico -->
        </div>
      </div>
    </section>

    <section class="route" id="route-proyectos" style="display:none">
      <div class="card">
        <h3>Proyectos & Tareas</h3>
        <p class="muted">Incluye proyectos, tareas dependientes, calendario editable y Gantt (siguiente bloque).</p>
      </div>
    </section>

    <section class="route" id="route-apuntes" style="display:none">
      <div class="card">
        <h3>Apuntes (Intranet)</h3>
        <p class="muted">Páginas a la izquierda y editor a la derecha (siguiente bloque).</p>
      </div>
    </section>

    <section class="route" id="route-rrhh" style="display:none">
      <div class="card">
        <h3>RR.HH.</h3>
        <p class="muted">Empleados, ausencias, turnos, evaluaciones, organigrama, onboarding (siguiente bloque).</p>
      </div>
    </section>

    <section class="route" id="route-export" style="display:none">
      <div class="card">
        <h3>Exportador</h3>
        <p class="muted">Imprime / guarda como PDF secciones específicas y descarga imágenes de gráficos.</p>
        <div class="row cols-3">
          <div class="card">
            <h4>Exportar Principal</h4>
            <button class="btn" onclick="printSection('route-principal')">Imprimir/Guardar</button>
          </div>
          <div class="card">
            <h4>Exportar Inventario</h4>
            <button class="btn" onclick="printSection('route-inventario')">Imprimir/Guardar</button>
          </div>
          <div class="card">
            <h4>Exportar CRM</h4>
            <button class="btn" onclick="printSection('route-crm')">Imprimir/Guardar</button>
          </div>
          <div class="card">
            <h4>Exportar Proyectos</h4>
            <button class="btn" onclick="printSection('route-proyectos')">Imprimir/Guardar</button>
          </div>
          <div class="card">
            <h4>Exportar Apuntes</h4>
            <button class="btn" onclick="printSection('route-apuntes')">Imprimir/Guardar</button>
          </div>
          <div class="card">
            <h4>Exportar RR.HH.</h4>
            <button class="btn" onclick="printSection('route-rrhh')">Imprimir/Guardar</button>
          </div>
        </div>
      </div>
    </section>
    <section class="route" id="route-soporte" style="display:none">
  <div class="card">
    <h3>Soporte e Instrucciones de Uso</h3>
    <ul style="line-height:1.8; font-size:16px; margin-bottom:18px">
      <li><b>Navegación:</b> Usa el menú lateral izquierdo para acceder a cada módulo del sistema.</li>
      <li><b>Principal:</b> Visualiza tus KPIs, ingresos, costos, tareas pendientes y el historial de transacciones. Puedes filtrar, añadir, editar y eliminar transacciones.</li>
      <li><b>Inventario:</b> Gestiona tus repuestos. Añade, edita o elimina productos. Visualiza el stock y el valor de inventario en gráficos.</li>
      <li><b>CRM & Ventas:</b> Administra contactos, empresas y documentos (cotizaciones/facturas). Exporta o imprime la información.</li>
      <li><b>Proyectos & Tareas:</b> Crea proyectos, asigna tareas, visualiza el calendario y el diagrama de Gantt. Marca el avance de cada tarea.</li>
      <li><b>Apuntes:</b> Usa el editor tipo intranet para tomar notas, crear plantillas y exportar/importar documentos.</li>
      <li><b>RR.HH.:</b> Gestiona empleados, ausencias, turnos, evaluaciones, organigrama y checklist de onboarding.</li>
      <li><b>Exportar:</b> Imprime o guarda en PDF cualquier sección y descarga gráficos como imágenes, nota: por el momento esta opción está en mantenimiento.</li>
      <li><b>Copia de seguridad:</b> Usa "Descargar backup" para guardar toda tu información y "Restaurar backup" para recuperarla.</li>
      <li><b>Guardar manual:</b> El botón "Guardar todo" asegura que los cambios se almacenen en tu navegador.</li>
      <li><b>Seguridad:</b> Todos los datos se guardan localmente en tu navegador. No se comparten ni suben a internet.</li>
      <li><b>Recomendación:</b> Realiza copias de seguridad periódicas y guárdalas en un lugar seguro.</li>
      <li><b>Soporte:</b> Si tienes dudas o problemas, contacta a tu proveedor o revisa este panel para instrucciones.</li>
    </ul>
    <div class="muted" style="font-size:14px">
      <b>Atajos útiles:</b>
      <ul>
        <li><b>CTRL + K</b>: Buscar en tablas</li>
        <li><b>CTRL + S</b>: Guardar nota en Apuntes</li>
      </ul>
      <b>¿Dudas?</b> Consulta este panel o solicita ayuda a tu soporte técnico.
    </div>
  </div>
</section>
  </main>

  <!-- ===================== SCRIPTS ===================== -->
  <script>
  // =============================================================
  //  Utils de fechas y formato
  // =============================================================
  const fmt = new Intl.NumberFormat('es-PE', { style:'currency', currency:'PEN', maximumFractionDigits:2 });
  const todayISO = () => new Date().toISOString().slice(0,10);
  const parseISO = (d) => { const [y,m,da] = d.split('-').map(Number); return new Date(y, m-1, da); };
  const addDays = (date, n) => { const d = new Date(date); d.setDate(d.getDate()+n); return d };
  const between = (date, start, end) => (date>=start && date<=end);
  const toISO = (date) => date.toISOString().slice(0,10);
  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

  // =============================================================
  //  Router simple de secciones
  // =============================================================
const routes = ['principal','inventario','crm','proyectos','apuntes','rrhh','export','soporte'];  
  function showRoute(name){
    routes.forEach(r=>{
      const el = document.getElementById('route-'+r);
      if(!el) return;
      el.style.display = (r===name)?'block':'none';
    });
    document.querySelectorAll('#sidebar .nav button').forEach(b=>{
      b.classList.toggle('active', b.dataset.route===name)
    });
    document.getElementById('crumb').textContent = name.charAt(0).toUpperCase()+name.slice(1);
    window.scrollTo({top:0, behavior:'smooth'});
    // Guarda la última ruta
  localStorage.setItem('microerp_last_route', name);
  }

  // =============================================================
  //  Almacenamiento local (store) — clave única del app
  // =============================================================
  const STORE_KEY = 'microerp_repuestos_v1';
  const defaultState = () => ({
    txSeq: 1,
    transacciones: [
      // demo inicial
      { id: 1, numero:'TX-0001', fecha: toISO(addDays(new Date(), -2)), cliente:'Taller Don Pepe', descripcion:'Venta de pastillas de freno + mano de obra', total: 380.00, pagado:true, estado:'Completado' },
    ],
    inventario: [
      { codigo:'REP-001', nombre:'Filtro de aceite', cantidad: 25, puc: 18.5, puv: 35.0 },
      { codigo:'REP-002', nombre:'Pastillas de freno', cantidad: 40, puc: 45.0, puv: 80.0 },
      { codigo:'REP-003', nombre:'Bujía', cantidad: 60, puc: 12.0, puv: 25.0 },
    ],
    contactos: [], empresas: [], docs: [],
    proyectos: [], tareas: [], calendario: {},
    apuntes: { pages: [], content: {} },
    rrhh: { empleados: [], ausencias: [], turnos: [], evaluaciones: [], onboarding: [] }
  });

  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw){
        const st = defaultState();
        localStorage.setItem(STORE_KEY, JSON.stringify(st));
        return st;
      }
      return JSON.parse(raw);
    }catch(e){
      console.error('Error cargando estado, usando por defecto', e);
      const st = defaultState();
      localStorage.setItem(STORE_KEY, JSON.stringify(st));
      return st;
    }
  }
  function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  let state = loadState();

  // =============================================================
  //  Render principal: KPIs, gráfico y tabla de transacciones
  // =============================================================
  function calcMetrics(rangeStart, rangeEnd){
  const txRange = state.transacciones.filter(tx => between(parseISO(tx.fecha), rangeStart, rangeEnd));
  // Solo ingresos empresa
  const ingresos = txRange
    .filter(t => t.tipo === 'ingreso')
    .reduce((a, t) => a + (t.pagado ? Number(t.total) : 0), 0);
  // Costos = gastos empresa + reinversión capital
  const costos = txRange
    .filter(t => t.tipo === 'gasto' || t.tipo === 'reinversion')
    .reduce((a, t) => a + (t.pagado ? Number(t.total) : 0), 0);
  const ganancia = ingresos - costos;
  const tareasPend = state.tareas.filter(t => (typeof t.avance === 'number' ? t.avance < 100 : true)).length || 0;
  const proyectosAct = state.proyectos.length || 0;

  // extra: ticket promedio y uso para resumen
  const tickets = txRange.filter(t => t.tipo === 'ingreso').map(t => Number(t.total));
  const ticketProm = tickets.length ? (tickets.reduce((a, b) => a + b, 0) / tickets.length) : 0;

  return { ingresos, costos, ganancia, tareasPend, proyectosAct, diasConVentas: new Set(txRange.map(t=>t.fecha)).size, baseDias: Math.floor((rangeEnd - rangeStart)/(1000*60*60*24))+1, ticketProm };
}

  function renderKPIs(){
    const end = new Date();
    const start = addDays(end, -14);
    const m = calcMetrics(start, end);
    document.getElementById('kpiIngresos').textContent = fmt.format(m.ingresos);
    document.getElementById('kpiCostos').textContent = fmt.format(m.costos);
    document.getElementById('kpiGanancia').textContent = fmt.format(m.ganancia);
    document.getElementById('kpiTareas').textContent = m.tareasPend;
    document.getElementById('kpiProyectos').textContent = m.proyectosAct;

    document.getElementById('sumTicket').textContent = fmt.format(m.ticketProm);
    document.getElementById('sumDiasVenta').textContent = m.diasConVentas;
    document.getElementById('sumBaseDias').textContent = m.baseDias;
  }

  // ============== Tabla de transacciones ==============
  function renderTxTable(){
  const tbody = document.getElementById('txBody');
  const tipoSel = document.getElementById('txTipoFilter');
  const tipoFiltro = tipoSel ? tipoSel.value : '';
  tbody.innerHTML = '';
  state.transacciones
    .filter(tx => !tipoFiltro || tx.tipo === tipoFiltro)
    .sort((a,b)=> a.fecha<b.fecha?1:-1)
    .forEach(tx => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${tx.numero || ('TX-'+String(tx.id).padStart(4,'0'))}</td>
        <td>${tx.fecha}</td>
        <td>${tx.cliente}</td>
        <td><details><summary>Ver</summary>${tx.descripcion||''}</details></td>
        <td>${fmt.format(tx.total)} ${tx.pagado?'':'<span class="muted">(pend.)</span>'}</td>
        <td>${tx.estado}</td>
        <td>${tx.tipo==='ingreso'?'Ingresos empresa':tx.tipo==='gasto'?'Gastos empresa':'Reinversión capital'}</td>
        <td>
  <button class="btn ghost" onclick="editTx(${tx.id})">Editar</button>
  <button class="btn ghost" onclick="viewTx(${tx.id})">Ver</button>
  <button class="btn bad" onclick="deleteTx(${tx.id})">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
}

// Recarga la tabla al cambiar el filtro
document.getElementById('txTipoFilter').addEventListener('change', renderTxTable);

  function viewTx(id){
    const tx = state.transacciones.find(t=>t.id===id);
    if(!tx) return;
    alert(`Transacción\n#${tx.numero || ('TX-'+String(tx.id).padStart(4,'0'))}\nFecha: ${tx.fecha}\nCliente: ${tx.cliente}\nTotal: ${fmt.format(tx.total)}\nEstado: ${tx.estado}\nPagado: ${tx.pagado?'Sí':'No'}\n\nDescripción:\n${tx.descripcion||'-'}`);
  }
  function editTx(id){
  const tx = state.transacciones.find(t=>t.id===id);
  if(!tx) return;
  const dlg = document.getElementById('txnDialog');
  const form = document.getElementById('txnForm');
  form.reset();
  form.fecha.value = tx.fecha;
  form.cliente.value = tx.cliente;
  form.estado.value = tx.estado;
  form.descripcion.value = tx.descripcion;
  form.total.value = tx.total;
  form.pagado.value = tx.pagado ? 'si' : 'no';
  form.tipo.value = tx.tipo || 'ingreso';
  form.numero.value = tx.numero || '';
  form.dataset.editId = id;
  dlg.showModal();

  dlg.addEventListener('close', function handler(){
    if(dlg.returnValue!=="confirm") { dlg.removeEventListener('close', handler); return; }
    const fd = new FormData(form);
    const editId = Number(form.dataset.editId);
    const updated = {
      id: editId,
      numero: (fd.get('numero')||'').trim() || ('TX-'+String(editId).padStart(4,'0')),
      fecha: fd.get('fecha'),
      cliente: (fd.get('cliente')||'').trim(),
      descripcion: (fd.get('descripcion')||'').trim(),
      total: Number(fd.get('total'))||0,
      pagado: fd.get('pagado')==='si',
      estado: fd.get('estado'),
      tipo: fd.get('tipo') || 'ingreso'
    };
    state.transacciones = state.transacciones.map(t=> t.id===editId ? updated : t);
    saveState();
    renderTxTable();
    renderKPIs();
    drawSalesChart();
    dlg.removeEventListener('close', handler);
  });
}
  function deleteTx(id){
    if(!confirm('¿Eliminar transacción?')) return;
    state.transacciones = state.transacciones.filter(t=>t.id!==id);
    saveState();
    renderTxTable();
    renderKPIs();
    drawSalesChart();
  }

  // ============== Formulario de nueva transacción ==============
 function setupTxnForm(){
    const dlg = document.getElementById('txnDialog');
    const form = document.getElementById('txnForm');
    document.getElementById('addTxnBtn').addEventListener('click',()=>{
      form.reset();
      form.fecha.value = todayISO();
      form.dataset.editId = ""; // <-- Limpia el flag de edición
      dlg.showModal();
    });

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=="confirm") return;
      const fd = new FormData(form);
      if(form.dataset.editId){ // Si es edición
        const editId = Number(form.dataset.editId);
        const updated = {
          id: editId,
          numero: (fd.get('numero')||'').trim() || ('TX-'+String(editId).padStart(4,'0')),
          fecha: fd.get('fecha'),
          cliente: (fd.get('cliente')||'').trim(),
          descripcion: (fd.get('descripcion')||'').trim(),
          total: Number(fd.get('total'))||0,
          pagado: fd.get('pagado')==='si',
          estado: fd.get('estado'),
          tipo: fd.get('tipo') || 'ingreso'
        };
        state.transacciones = state.transacciones.map(t=> t.id===editId ? updated : t);
        form.dataset.editId = ""; // Limpia el flag
      } else { // Si es nueva
        const id = ++state.txSeq;
        const numero = (fd.get('numero')||'').trim() || ('TX-'+String(id).padStart(4,'0'));
        const nuevo = {
          id,
          numero,
          fecha: fd.get('fecha'),
          cliente: (fd.get('cliente')||'').trim(),
          descripcion: (fd.get('descripcion')||'').trim(),
          total: Number(fd.get('total'))||0,
          pagado: fd.get('pagado')==='si',
          estado: fd.get('estado'),
          tipo: fd.get('tipo') || 'ingreso'
        };
        state.transacciones.push(nuevo);
      }
      saveState();
      renderTxTable();
      renderKPIs();
      drawSalesChart();
    });
}

  // =============================================================
  //  Gráfico de ingresos (canvas sin librerías)
  // =============================================================
  function getChartData(){
  const periodSel = document.getElementById('chartPeriod').value;
  const monthSel = document.getElementById('chartMonth');

  let labels = [], values = [], start, end;

  if(periodSel==='15'){
    end = new Date();
    start = addDays(end, -14);
    for(let d=0; d<15; d++){
      const day = addDays(start, d);
      const key = toISO(day);
      labels.push(key.slice(5));
      // SOLO ingresos empresa
      const sum = state.transacciones
        .filter(t=> t.pagado && t.fecha===key && t.tipo==='ingreso')
        .reduce((a,t)=> a+Number(t.total), 0);
      values.push(sum);
    }
  } else if(periodSel==='month'){
    const [y, m] = monthSel.value.split('-').map(Number); // yyyy-mm
    const first = new Date(y, m-1, 1);
    const last = new Date(y, m, 0);
    start = first; end = last;
    const days = last.getDate();
    for(let d=1; d<=days; d++){
      const key = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      labels.push(String(d));
      // SOLO ingresos empresa
      const sum = state.transacciones
        .filter(t=> t.pagado && t.fecha===key && t.tipo==='ingreso')
        .reduce((a,t)=> a+Number(t.total), 0);
      values.push(sum);
    }
  } else { // year
    const y = new Date().getFullYear();
    start = new Date(y,0,1); end = new Date(y,11,31);
    for(let m=1; m<=12; m++){
      labels.push(monthNames[m-1].slice(0,3));
      // SOLO ingresos empresa
      const sum = state.transacciones
        .filter(t=> t.pagado && t.fecha.startsWith(`${y}-${String(m).padStart(2,'0')}`) && t.tipo==='ingreso')
        .reduce((a,t)=> a+Number(t.total), 0);
      values.push(sum);
    }
  }

  return { labels, values, start, end };
}

  function drawGrid(ctx, w, h, stepY){
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1;
    for(let y=h-30; y>20; y-=stepY){
      ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(w-10,y); ctx.stroke();
    }
    ctx.restore();
  }

  function drawSalesChart(){
    const canvas = document.getElementById('salesChart');
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const { labels, values, start, end } = getChartData();

    // ejes
    ctx.strokeStyle = '#294255';
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,h-20); ctx.lineTo(w-10,h-20); ctx.stroke();

    const maxVal = Math.max(10, ...values);
    drawGrid(ctx, w, h, Math.max(20, Math.floor((h-60)/5)));

    // Escalas
    const left = 50, right = w-20, top = 20, bottom = h-30;
    const innerW = right-left, innerH = bottom-top;

    // Etiquetas X
    ctx.fillStyle = '#9fb3c8';
    ctx.font = '12px system-ui';
    const stepX = innerW / Math.max(1, (labels.length-1));
    labels.forEach((lab,i)=>{
      const x = left + i*stepX;
      if(i%Math.ceil(labels.length/10)===0 || labels.length<=15){
        ctx.fillText(lab, x-8, h-8);
      }
    });

    // Etiquetas Y (3 marcas)
    for(let i=0;i<=3;i++){
      const val = Math.round((maxVal*i/3));
      const y = bottom - (val/maxVal)*innerH;
      ctx.fillText('S/ '+val, 4, y+4);
    }

    // Línea
    ctx.strokeStyle = '#3dd6d0';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    values.forEach((v,i)=>{
      const x = left + i*stepX;
      const y = bottom - (v/maxVal)*innerH;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Puntos
    ctx.fillStyle = '#7ef5f0';
    values.forEach((v,i)=>{
      const x = left + i*stepX;
      const y = bottom - (v/maxVal)*innerH;
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    });

    // Resumen superior izquierdo
    const sum = values.reduce((a,b)=>a+b,0);
    ctx.fillStyle = '#cfe8ff';
    ctx.font = 'bold 14px system-ui';
    ctx.fillText('Total: '+fmt.format(sum), 60, 18);
  }

  function downloadChart(){
    const canvas = document.getElementById('salesChart');
    const a = document.createElement('a');
    a.download = 'ingresos.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  }

  // =============================================================
  //  Exportar sección (print)
  // =============================================================
  function printSection(sectionId){
    // Oculta todas las rutas menos la solicitada, imprime y restaura
    const vis = {};
    routes.forEach(r=>{
      const el = document.getElementById('route-'+r);
      vis[r] = el.style.display;
      el.style.display = (('route-'+r)===sectionId)?'block':'none';
    });
    window.print();
    // restaurar
    routes.forEach(r=>{
      const el = document.getElementById('route-'+r);
      el.style.display = vis[r];
    });
  }

  // =============================================================
  //  Búsqueda global simple en tablas visibles
  // =============================================================
  function setupGlobalSearch(){
    const input = document.getElementById('globalSearch');
    function filter(){
      const term = input.value.toLowerCase();
      const tables = document.querySelectorAll('.route:not([style*="display: none"]) table');
      tables.forEach(tbl=>{
        const tbody = tbl.tBodies[0];
        if(!tbody) return;
        Array.from(tbody.rows).forEach(row=>{
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(term)?'':'none';
        });
      });
    }
    input.addEventListener('input', filter);
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault(); input.focus(); input.select();
      }
    });
  }

  // =============================================================
  //  Export CSV utilitario
  // =============================================================
  function exportTableCSV(tableId, filename){
    const tbl = document.getElementById(tableId);
    const rows = Array.from(tbl.querySelectorAll('tr'));
    const csv = rows.map(tr=> Array.from(tr.children).map(td=> '"'+td.innerText.replaceAll('"','""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
  }

  // =============================================================
  //  Inicialización
  // =============================================================
  function init(){
  // Hoy
  document.getElementById('today').textContent = new Date().toLocaleDateString('es-PE', {weekday:'short', year:'numeric', month:'short', day:'numeric'});

  // Sidebar rutas
  document.querySelectorAll('#sidebar .nav button').forEach(btn=>{
    btn.addEventListener('click', ()=> showRoute(btn.dataset.route));
  });

  // Búsqueda
  setupGlobalSearch();

  // KPIs + Tabla
  renderKPIs();
  renderTxTable();

  // Chart periodo
  const chartPeriod = document.getElementById('chartPeriod');
  const chartMonth = document.getElementById('chartMonth');
  // Llenar meses del año actual
  const y = new Date().getFullYear();
  chartMonth.innerHTML = Array.from({length:12}, (_,i)=>`<option value="${y}-${String(i+1).padStart(2,'0')}">${monthNames[i]}</option>`).join('');
  chartPeriod.addEventListener('change', ()=>{
    chartMonth.style.display = (chartPeriod.value==='month')?'inline-block':'none';
    drawSalesChart();
  });
  chartMonth.addEventListener('change', drawSalesChart);

  document.getElementById('downloadChartBtn').addEventListener('click', downloadChart);

  // Form transacciones
  setupTxnForm();

  // Dibuja gráfico
  drawSalesChart();

  // Restaurar última ruta
  const lastRoute = localStorage.getItem('microerp_last_route') || 'principal';
  showRoute(lastRoute);
}

  window.addEventListener('DOMContentLoaded', init);
  window.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('saveAllBtn');
  if(btn){
    btn.addEventListener('click', function(){
      saveState();
      alert('¡Todos los datos han sido guardados de forma segura en este navegador!');
    });
  }
});
    // =============================================================
  //  Inventario: render, CRUD y gráficos (Bloque 2)
  // =============================================================

  // Bandera de edición (cuando editamos un repuesto existente)
  let invEditId = null;

  // Derivados de inventario (costo total y ganancia unitaria)
  function computeInvDerived(it){
    const costoTotal = (Number(it.cantidad)||0) * (Number(it.puc)||0);
    const ganancia = (Number(it.puv)||0) - (Number(it.puc)||0);
    return { costoTotal, ganancia };
  }

  // Render de la tabla de inventario
  function renderInventoryTable(){
    const tbody = document.getElementById('invBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    state.inventario.forEach((it)=>{
      const { costoTotal, ganancia } = computeInvDerived(it);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.codigo}</td>
        <td>${it.nombre}</td>
        <td>${it.cantidad}</td>
        <td>${fmt.format(it.puc)}</td>
        <td>${fmt.format(costoTotal)}</td>
        <td>${fmt.format(it.puv)}</td>
        <td>${fmt.format(ganancia)}</td>
        <td>
          <button class="btn ghost" onclick="editInv('${it.codigo}')">Editar</button>
          <button class="btn bad" onclick="deleteInv('${it.codigo}')">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // Editar repuesto
  function editInv(codigo){
    const it = state.inventario.find(x=>x.codigo===codigo);
    if(!it) return;
    invEditId = codigo;
    const dlg = document.getElementById('invDialog');
    const f = document.getElementById('invForm');
    const title = document.getElementById('invDialogTitle');
    if(title) title.textContent = 'Editar repuesto';
    if(f){
      f.codigo.value = it.codigo;
      f.nombre.value = it.nombre;
      f.cantidad.value = it.cantidad;
      f.puc.value = it.puc;
      f.puv.value = it.puv;
    }
    if(dlg) dlg.showModal();
  }

  // Eliminar repuesto
  function deleteInv(codigo){
    if(!confirm('¿Eliminar repuesto '+codigo+'?')) return;
    state.inventario = state.inventario.filter(x=>x.codigo!==codigo);
    saveState();
    renderInventoryTable();
    drawInvCharts();
  }

  // Setup del formulario de inventario (añadir/editar)
  function setupInventoryForm(){
    const btn = document.getElementById('addItemBtn');
    const dlg = document.getElementById('invDialog');
    const f = document.getElementById('invForm');

    if(btn){
      btn.addEventListener('click', ()=>{
        invEditId = null;
        if(f) f.reset();
        const title = document.getElementById('invDialogTitle');
        if(title) title.textContent = 'Nuevo repuesto';
        if(dlg) dlg.showModal();
      });
    }

    

    if(dlg){
      dlg.addEventListener('close', ()=>{
        if(dlg.returnValue!=="confirm") return;
        const fd = new FormData(f);
        const nuevo = {
          codigo: (fd.get('codigo')||'').trim(),
          nombre: (fd.get('nombre')||'').trim(),
          cantidad: Number(fd.get('cantidad'))||0,
          puc: Number(fd.get('puc'))||0,
          puv: Number(fd.get('puv'))||0,
        };
        if(!nuevo.codigo || !nuevo.nombre){ alert('Completa código y nombre.'); return; }

        const exists = state.inventario.find(x=>x.codigo===nuevo.codigo);
        if(invEditId){
          // Si cambiaron el código, evitar colisión
          if(exists && exists.codigo!==invEditId){
            alert('Ya existe un repuesto con ese código.'); return;
          }
          state.inventario = state.inventario.map(x=> x.codigo===invEditId ? nuevo : x);
        } else {
          if(exists){ alert('Ya existe un repuesto con ese código.'); return; }
          state.inventario.push(nuevo);
        }

        saveState();
        renderInventoryTable();
        drawInvCharts();
      });
    }
  }

  // =============================================================
  //  Gráficos de Inventario (canvas puro, sin librerías)
  // =============================================================

  // Barras genéricas (para reutilizar con distintos datos)
  function drawBarChart(canvasId, labels, values, title){
    const c = document.getElementById(canvasId);
    if(!c) return;
    const ctx = c.getContext('2d');
    const w=c.width, h=c.height;
    ctx.clearRect(0,0,w,h);

    // Ejes
    ctx.strokeStyle = '#294255';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(40,10); ctx.lineTo(40,h-30); ctx.lineTo(w-10,h-30); ctx.stroke();

    // Grid
    ctx.strokeStyle='rgba(255,255,255,.08)';
    for(let y=h-30; y>20; y-=30){
      ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-10,y); ctx.stroke();
    }

    const maxVal = Math.max(10, ...values);
    const left=50, right=w-20, top=20, bottom=h-30;
    const innerW = right-left, innerH = bottom - top;
    const n = labels.length;
    const barW = Math.max(10, Math.floor((innerW - 20) / Math.max(1, n*1.4)));
    const gap = Math.max(8, Math.floor(barW*0.4));
    const stepX = (barW + gap);

    // Título
    ctx.fillStyle = '#cfe8ff';
    ctx.font = 'bold 14px system-ui';
    if(title) ctx.fillText(title, 60, 18);

    // Etiquetas Y
    ctx.fillStyle = '#9fb3c8';
    ctx.font = '12px system-ui';
    for(let i=0;i<=3;i++){
      const val = Math.round((maxVal * i)/3);
      const y = bottom - (val/maxVal)*innerH;
      ctx.fillText('S/ '+val, 4, y+4);
    }

    // Barras
    ctx.fillStyle = '#3dd6d0';
    labels.forEach((lab, i)=>{
      const x = left + i*stepX;
      const v = values[i]||0;
      const hBar = (v/maxVal)*innerH;
      const y = bottom - hBar;
      ctx.fillRect(x, y, barW, hBar);

      // Etiqueta X (no saturar)
      if (barW >= 18 || i % Math.ceil(labels.length/10) === 0){
        ctx.fillStyle = '#9fb3c8';
        ctx.fillText(lab, x, h-8);
        ctx.fillStyle = '#3dd6d0';
      }
    });

    // Línea de promedio
    const avg = values.reduce((a,b)=>a+b,0) / Math.max(1, values.length);
    const yAvg = bottom - (avg/maxVal)*innerH;
    ctx.strokeStyle = '#7ef5f0';
    ctx.setLineDash([6,6]);
    ctx.beginPath(); ctx.moveTo(40, yAvg); ctx.lineTo(w-10, yAvg); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#cfe8ff';
    ctx.fillText('Prom: '+fmt.format(avg), w-160, yAvg-6);
  }

  // Ensamblar datos y dibujar ambos gráficos
  function drawInvCharts(){
    // Chart 1: Cantidades por repuesto
    const labels1 = state.inventario.map(it=> it.codigo);
    const values1 = state.inventario.map(it=> Number(it.cantidad)||0);
    drawBarChart('invBarChart', labels1, values1, 'Stock (unidades) por repuesto');

    // Chart 2: Valor en almacén (Costo Total) por repuesto
    const labels2 = state.inventario.map(it=> it.codigo);
    const values2 = state.inventario.map(it=> (Number(it.cantidad)||0) * (Number(it.puc)||0));
    drawBarChart('invValChart', labels2, values2, 'Valor de inventario (S/) por repuesto');
  }

  // =============================================================
  //  Integración de navegación y refrescos
  // =============================================================
  (function(){
    // Guardamos referencia de showRoute para extenderla (sin romper la original)
    const _show = window.showRoute;
    window.showRoute = function(name){
      _show(name);
      // Al entrar a Inventario, refrescar tabla y charts
      if(name==='inventario'){
        renderInventoryTable();
        drawInvCharts();
      }
      // Al regresar a Principal, refrescar dashboard
      if(name==='principal'){
        renderKPIs();
        drawSalesChart();
      }
    }
  })();

  // =============================================================
  //  Inicialización complementaria (Inventario)
  // =============================================================
  window.addEventListener('DOMContentLoaded', ()=>{
    setupInventoryForm();
    renderInventoryTable();
    drawInvCharts();
  });

  // =============================================================
  //  Helpers/Extensiones futuros (placeholder)
  // =============================================================
  // En futuras iteraciones: vincular ventas con salidas de inventario,
  // rotación, cobertura de stock, y alertas de mínimos.

  // Exponer utilidades por si deseas inspeccionarlas desde la consola
  window.microerp = Object.assign(window.microerp||{}, {
    renderInventoryTable,
    drawInvCharts
  });

  // ======================= FIN BLOQUE 2 =======================
  // =============================================================
  //  Bloque 3: CRM & Ventas — Contactos, Empresas, Docs
  //  - CRUD básico en cada pestaña
  //  - Exportar CSV / Imprimir sección
  //  - Vínculo opcional: Doc -> Transacción
  // =============================================================

  // -------------------------- Estado inicial y helpers --------------------------
  // Añadimos contadores si aún no existen
  if(typeof state.contactSeq !== 'number') state.contactSeq = 0;
  if(typeof state.empresaSeq !== 'number') state.empresaSeq = 0;
  if(typeof state.docSeq !== 'number') state.docSeq = 0;

  // Si el usuario no tiene datos de ejemplo, añadimos algunos
  if(!state.contactos || !Array.isArray(state.contactos)) state.contactos = [];
  if(!state.empresas || !Array.isArray(state.empresas)) state.empresas = [];
  if(!state.docs || !Array.isArray(state.docs)) state.docs = [];

  if(state.contactos.length===0){
    state.contactos.push({ id: ++state.contactSeq, nombre:'Juan Pérez', telefono:'999888777', email:'juan@example.com', empresaId:null, notas:'' });
    state.contactos.push({ id: ++state.contactSeq, nombre:'María Reyes', telefono:'988777666', email:'maria@example.com', empresaId:null, notas:'' });
  }
  if(state.empresas.length===0){
    state.empresas.push({ id: ++state.empresaSeq, nombre:'Taller Don Pepe', ruc:'20123456789', telefono:'014445555', direccion:'Av. Las Lomas 123', notas:'' });
    state.empresas.push({ id: ++state.empresaSeq, nombre:'Transportes Andinos', ruc:'20654321987', telefono:'015553333', direccion:'Jr. Cusco 456', notas:'' });
  }
  if(state.docs.length===0){
    state.docs.push({
      id: ++state.docSeq,
      tipo: 'Cotización',
      numero: 'COT-0001',
      fecha: toISO(new Date()),
      contactoId: state.contactos[0]?.id || null,
      empresaId: state.empresas[0]?.id || null,
      descripcion: 'Cambio de pastillas de freno + repuesto',
      total: 480.00,
      estado: 'Pendiente',   // Pendiente | Aprobada | Facturada | Cancelada
      pagado: false
    });
  }
  saveState();

  // Utilidad para crear/obtener un <dialog> reutilizable
  function ensureDialog(id){
    let dlg = document.getElementById(id);
    if(!dlg){
      dlg = document.createElement('dialog');
      dlg.id = id;
      document.body.appendChild(dlg);
    }
    return dlg;
  }

  // Devuelve nombre de empresa por id
  function empresaNameById(id){
    const e = state.empresas.find(x=>x.id===id);
    return e? e.nombre : '—';
  }
  // Devuelve nombre de contacto por id
  function contactoNameById(id){
    const c = state.contactos.find(x=>x.id===id);
    return c? c.nombre : '—';
  }

  // -------------------------- Tabs CRM --------------------------
  const crmTabs = [
    { key:'contactos', label:'Contactos' },
    { key:'empresas',  label:'Empresas' },
    { key:'docs',      label:'Cotizaciones / Facturas' }
  ];

  function setupCrmTabs(){
    const tabsBar = document.querySelector('#route-crm .tabs');
    const container = document.getElementById('crmTabContent');
    if(!tabsBar || !container) return;

    // (Re)bind
    tabsBar.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabsBar.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderCrmTab(btn.dataset.crmTab);
      });
    });

    // Render inicial
    renderCrmTab('contactos');
  }

  function renderCrmTab(key){
    if(key==='contactos') renderCrmContactos();
    else if(key==='empresas') renderCrmEmpresas();
    else renderCrmDocs();
  }

  // -------------------------- CONTACTOS --------------------------
  function renderCrmContactos(){
    const container = document.getElementById('crmTabContent');
    if(!container) return;

    container.innerHTML = `
      <div class="card" style="padding:0; background:transparent; border:none">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
          <div style="display:flex; gap:8px; align-items:center">
            <h3 style="margin:0">Contactos</h3>
            <span class="pill muted">Total: ${state.contactos.length}</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn ok" id="addContactoBtn">Añadir</button>
            <button class="btn ghost" onclick="exportTableCSV('contactosTable','contactos.csv')">Exportar CSV</button>
            <button class="btn ghost" onclick="printSection('route-crm')">Imprimir</button>
          </div>
        </div>
        <table id="contactosTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Teléfono</th>
              <th>Email</th>
              <th>Empresa</th>
              <th>Notas</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="contactosBody"></tbody>
        </table>
      </div>
    `;

    const tbody = container.querySelector('#contactosBody');
    state.contactos.forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td>${c.nombre}</td>
        <td>${c.telefono||'—'}</td>
        <td>${c.email||'—'}</td>
        <td>${c.empresaId? empresaNameById(c.empresaId) : '—'}</td>
        <td><details><summary>Ver</summary>${c.notas? c.notas.replaceAll('<','&lt;') : ''}</details></td>
        <td>
          <button class="btn ghost" onclick="editContacto(${c.id})">Editar</button>
          <button class="btn bad" onclick="deleteContacto(${c.id})">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('addContactoBtn').addEventListener('click', ()=> openContactoDialog());
  }

  function openContactoDialog(item){
    const dlg = ensureDialog('dlgContacto');
    const isEdit = !!item;
    const title = isEdit? 'Editar contacto' : 'Nuevo contacto';

    const empresaOptions = ['<option value="">— Ninguna —</option>']
      .concat(state.empresas.map(e=> `<option value="${e.id}" ${item && item.empresaId===e.id?'selected':''}>${e.nombre}</option>`))
      .join('');

    dlg.innerHTML = `
      <form id="formContacto" method="dialog" style="min-width:600px">
        <h3>${title}</h3>
        <div class="row" style="grid-template-columns:repeat(2,1fr)">
          <div>
            <label>Nombre</label>
            <input type="text" name="nombre" value="${item?.nombre||''}" required />
          </div>
          <div>
            <label>Empresa</label>
            <select name="empresaId">${empresaOptions}</select>
          </div>
          <div>
            <label>Teléfono</label>
            <input type="text" name="telefono" value="${item?.telefono||''}" />
          </div>
          <div>
            <label>Email</label>
            <input type="text" name="email" value="${item?.email||''}" />
          </div>
          <div class="span-2">
            <label>Notas</label>
            <textarea name="notas">${item?.notas||''}</textarea>
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
          <button class="btn ghost" value="cancel">Cancelar</button>
          <button class="btn" value="confirm">Guardar</button>
        </div>
      </form>
    `;
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(dlg.querySelector('#formContacto'));
      const payload = {
        id: isEdit? item.id : ++state.contactSeq,
        nombre: (fd.get('nombre')||'').trim(),
        empresaId: fd.get('empresaId')? Number(fd.get('empresaId')): null,
        telefono: (fd.get('telefono')||'').trim(),
        email: (fd.get('email')||'').trim(),
        notas: (fd.get('notas')||'').trim()
      };
      if(!payload.nombre){ alert('Nombre requerido'); return; }
      if(isEdit){
        state.contactos = state.contactos.map(c=> c.id===item.id? payload : c);
      }else{
        state.contactos.push(payload);
      }
      saveState();
      renderCrmContactos();
    }, {once:true});
  }

  function editContacto(id){
    const item = state.contactos.find(c=> c.id===id);
    if(!item) return;
    openContactoDialog(item);
  }
  function deleteContacto(id){
    if(!confirm('¿Eliminar contacto?')) return;
    state.contactos = state.contactos.filter(c=> c.id!==id);
    // Limpiamos referencias en docs
    state.docs = state.docs.map(d=> d.contactoId===id? {...d, contactoId:null}: d);
    saveState();
    renderCrmContactos();
  }

  // -------------------------- EMPRESAS --------------------------
  function renderCrmEmpresas(){
    const container = document.getElementById('crmTabContent');
    if(!container) return;

    container.innerHTML = `
      <div class="card" style="padding:0; background:transparent; border:none">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
          <div style="display:flex; gap:8px; align-items:center">
            <h3 style="margin:0">Empresas</h3>
            <span class="pill muted">Total: ${state.empresas.length}</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn ok" id="addEmpresaBtn">Añadir</button>
            <button class="btn ghost" onclick="exportTableCSV('empresasTable','empresas.csv')">Exportar CSV</button>
            <button class="btn ghost" onclick="printSection('route-crm')">Imprimir</button>
          </div>
        </div>
        <table id="empresasTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>RUC</th>
              <th>Teléfono</th>
              <th>Dirección</th>
              <th>Notas</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="empresasBody"></tbody>
        </table>
      </div>
    `;

    const tbody = container.querySelector('#empresasBody');
    state.empresas.forEach((e,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td>${e.nombre}</td>
        <td>${e.ruc||'—'}</td>
        <td>${e.telefono||'—'}</td>
        <td>${e.direccion||'—'}</td>
        <td><details><summary>Ver</summary>${e.notas? e.notas.replaceAll('<','&lt;') : ''}</details></td>
        <td>
          <button class="btn ghost" onclick="editEmpresa(${e.id})">Editar</button>
          <button class="btn bad" onclick="deleteEmpresa(${e.id})">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('addEmpresaBtn').addEventListener('click', ()=> openEmpresaDialog());
  }

  function openEmpresaDialog(item){
    const dlg = ensureDialog('dlgEmpresa');
    const isEdit = !!item;
    const title = isEdit? 'Editar empresa' : 'Nueva empresa';

    dlg.innerHTML = `
      <form id="formEmpresa" method="dialog" style="min-width:600px">
        <h3>${title}</h3>
        <div class="row" style="grid-template-columns:repeat(2,1fr)">
          <div>
            <label>Nombre</label>
            <input type="text" name="nombre" value="${item?.nombre||''}" required />
          </div>
          <div>
            <label>RUC</label>
            <input type="text" name="ruc" value="${item?.ruc||''}" />
          </div>
          <div>
            <label>Teléfono</label>
            <input type="text" name="telefono" value="${item?.telefono||''}" />
          </div>
          <div>
            <label>Dirección</label>
            <input type="text" name="direccion" value="${item?.direccion||''}" />
          </div>
          <div class="span-2">
            <label>Notas</label>
            <textarea name="notas">${item?.notas||''}</textarea>
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
          <button class="btn ghost" value="cancel">Cancelar</button>
          <button class="btn" value="confirm">Guardar</button>
        </div>
      </form>
    `;
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(dlg.querySelector('#formEmpresa'));
      const payload = {
        id: isEdit? item.id : ++state.empresaSeq,
        nombre: (fd.get('nombre')||'').trim(),
        ruc: (fd.get('ruc')||'').trim(),
        telefono: (fd.get('telefono')||'').trim(),
        direccion: (fd.get('direccion')||'').trim(),
        notas: (fd.get('notas')||'').trim()
      };
      if(!payload.nombre){ alert('Nombre requerido'); return; }
      if(isEdit){
        state.empresas = state.empresas.map(e=> e.id===item.id? payload : e);
        // Sincronizar nombre en vistas derivadas no es necesario ahora (se lee en tiempo real)
      }else{
        state.empresas.push(payload);
      }
      saveState();
      renderCrmEmpresas();
    }, {once:true});
  }

  function editEmpresa(id){
    const item = state.empresas.find(e=> e.id===id);
    if(!item) return;
    openEmpresaDialog(item);
  }
  function deleteEmpresa(id){
    if(!confirm('¿Eliminar empresa?')) return;
    state.empresas = state.empresas.filter(e=> e.id!==id);
    // Limpiamos referencias en contactos y docs
    state.contactos = state.contactos.map(c=> c.empresaId===id? {...c, empresaId:null }: c);
    state.docs = state.docs.map(d=> d.empresaId===id? {...d, empresaId:null }: d);
    saveState();
    renderCrmEmpresas();
  }

  // -------------------------- DOCS (Cotizaciones/Facturas) --------------------------
  function renderCrmDocs(){
    const container = document.getElementById('crmTabContent');
    if(!container) return;

    container.innerHTML = `
      <div class="card" style="padding:0; background:transparent; border:none">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <h3 style="margin:0">Documentos</h3>
            <span class="pill muted">Total: ${state.docs.length}</span>
            <select id="docFilterEstado">
              <option value="">Todos</option>
              <option>Pendiente</option>
              <option>Aprobada</option>
              <option>Facturada</option>
              <option>Cancelada</option>
            </select>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn ok" id="addDocBtn">Añadir</button>
            <button class="btn ghost" onclick="exportTableCSV('docsTable','documentos.csv')">Exportar CSV</button>
            <button class="btn ghost" onclick="printSection('route-crm')">Imprimir</button>
          </div>
        </div>
        <table id="docsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Tipo</th>
              <th>Número</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Empresa</th>
              <th>Descripción</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Pagado</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="docsBody"></tbody>
        </table>
      </div>
    `;

    const filterSel = container.querySelector('#docFilterEstado');
    filterSel.addEventListener('change', ()=> renderDocsRows(filterSel.value));
    renderDocsRows('');
    container.querySelector('#addDocBtn').addEventListener('click', ()=> openDocDialog());
  }

  function renderDocsRows(estado){
    const tbody = document.getElementById('docsBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    let list = state.docs.slice().sort((a,b)=> a.fecha<b.fecha ? 1 : -1);
    if(estado) list = list.filter(d=> d.estado===estado);

    list.forEach((d,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td>${d.tipo}</td>
        <td>${d.numero||('DOC-'+String(d.id).padStart(4,'0'))}</td>
        <td>${d.fecha}</td>
        <td>${d.contactoId? contactoNameById(d.contactoId): '—'}</td>
        <td>${d.empresaId? empresaNameById(d.empresaId): '—'}</td>
        <td><details><summary>Ver</summary>${d.descripcion? d.descripcion.replaceAll('<','&lt;') : ''}</details></td>
        <td>${fmt.format(Number(d.total)||0)}</td>
        <td>${d.estado}</td>
        <td>${d.pagado? 'Sí' : 'No'}</td>
        <td style="display:flex; gap:6px; flex-wrap:wrap">
          <button class="btn ghost" onclick="editDoc(${d.id})">Editar</button>
          <button class="btn bad" onclick="deleteDoc(${d.id})">Eliminar</button>
          <button class="btn" onclick="convertDocToTxn(${d.id})">Registrar transacción</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openDocDialog(item){
    const dlg = ensureDialog('dlgDoc');
    const isEdit = !!item;
    const title = isEdit? 'Editar documento' : 'Nuevo documento';
    const tipo = item?.tipo || 'Cotización';

    const contactoOptions = ['<option value="">— Ninguno —</option>']
      .concat(state.contactos.map(c=> `<option value="${c.id}" ${item && item.contactoId===c.id?'selected':''}>${c.nombre}</option>`))
      .join('');

    const empresaOptions = ['<option value="">— Ninguna —</option>']
      .concat(state.empresas.map(e=> `<option value="${e.id}" ${item && item.empresaId===e.id?'selected':''}>${e.nombre}</option>`))
      .join('');

    dlg.innerHTML = `
      <form id="formDoc" method="dialog" style="min-width:760px">
        <h3>${title}</h3>
        <div class="row" style="grid-template-columns:repeat(3,1fr)">
          <div>
            <label>Tipo</label>
            <select name="tipo">
              <option ${tipo==='Cotización'?'selected':''}>Cotización</option>
              <option ${tipo==='Factura'?'selected':''}>Factura</option>
              <option ${tipo==='Boleta'?'selected':''}>Boleta</option>
            </select>
          </div>
          <div>
            <label>Número</label>
            <input type="text" name="numero" value="${item?.numero||''}" placeholder="AUTO si se deja vacío" />
          </div>
          <div>
            <label>Fecha</label>
            <input type="date" name="fecha" value="${item?.fecha||todayISO()}" required />
          </div>

          <div>
            <label>Contacto</label>
            <select name="contactoId">${contactoOptions}</select>
          </div>
          <div>
            <label>Empresa</label>
            <select name="empresaId">${empresaOptions}</select>
          </div>
          <div>
            <label>Estado</label>
            <select name="estado">
              ${['Pendiente','Aprobada','Facturada','Cancelada'].map(st=> `<option ${item?.estado===st?'selected':''}>${st}</option>`).join('')}
            </select>
          </div>

          <div class="span-3">
            <label>Descripción</label>
            <input type="text" name="descripcion" value="${item?.descripcion||''}" />
          </div>
          <div>
            <label>Total (S/)</label>
            <input type="number" step="0.01" name="total" value="${item?.total||0}" required />
          </div>
          <div>
            <label>¿Pagado?</label>
            <select name="pagado">
              <option value="si" ${item?.pagado?'selected':''}>Sí</option>
              <option value="no" ${!item?.pagado?'selected':''}>No</option>
            </select>
          </div>
          <div>
            <label># Interno</label>
            <input type="text" name="interno" value="${item?.id? 'DOC-'+String(item.id).padStart(4,'0'):''}" disabled />
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
          <button class="btn ghost" value="cancel">Cancelar</button>
          <button class="btn" value="confirm">Guardar</button>
        </div>
      </form>
    `;
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(dlg.querySelector('#formDoc'));
      const id = isEdit? item.id : ++state.docSeq;
      const numero = (fd.get('numero')||'').trim() || `${fd.get('tipo')==='Factura'?'FAC':'DOC'}-${String(id).padStart(4,'0')}`;
      const payload = {
        id,
        tipo: fd.get('tipo'),
        numero,
        fecha: fd.get('fecha'),
        contactoId: fd.get('contactoId')? Number(fd.get('contactoId')): null,
        empresaId: fd.get('empresaId')? Number(fd.get('empresaId')): null,
        descripcion: (fd.get('descripcion')||'').trim(),
        total: Number(fd.get('total'))||0,
        estado: fd.get('estado'),
        pagado: fd.get('pagado')==='si'
      };

      if(isEdit){
        state.docs = state.docs.map(d=> d.id===id? payload : d);
      } else {
        state.docs.push(payload);
      }
      saveState();
      renderCrmDocs();
    }, {once:true});
  }

  function editDoc(id){
    const item = state.docs.find(d=> d.id===id);
    if(!item) return;
    openDocDialog(item);
  }

  function deleteDoc(id){
    if(!confirm('¿Eliminar documento?')) return;
    state.docs = state.docs.filter(d=> d.id!==id);
    saveState();
    renderCrmDocs();
  }

  // Registrar un documento como transacción (interconecta con dashboard)
  function convertDocToTxn(id){
    const d = state.docs.find(x=> x.id===id);
    if(!d){ alert('Documento no encontrado'); return; }

    // Sugerimos número y datos
    const txId = ++state.txSeq;
    const numero = 'TX-'+String(txId).padStart(4,'0');
    const cliente = d.contactoId? contactoNameById(d.contactoId) : (d.empresaId? empresaNameById(d.empresaId) : 'Cliente s/n');
    const descripcion = `[${d.tipo} ${d.numero}] ${d.descripcion||''}`.trim();
    const pagado = !!d.pagado;
    const estado = d.estado==='Cancelada' ? 'Cancelado' : (pagado? 'Completado':'Pendiente');

    state.transacciones.push({
      id: txId,
      numero,
      fecha: d.fecha || todayISO(),
      cliente,
      descripcion,
      total: Number(d.total)||0,
      pagado,
      estado
    });

    // Si estaba en 'Aprobada' o 'Facturada', mantenemos; si era 'Pendiente' y pagado, la pasamos a 'Facturada'
    if(d.estado==='Pendiente' && pagado) d.estado = 'Facturada';
    saveState();

    // Refrescos
    renderTxTable();
    renderKPIs();
    drawSalesChart();
    alert('Documento registrado como transacción: '+numero);
  }

  // -------------------------- Integración de navegación --------------------------
  (function(){
    const _show = window.showRoute;
    window.showRoute = function(name){
      _show(name);
      if(name==='crm'){
        setupCrmTabs();
      }
    }
  })();

  // Inicializamos CRM si el usuario llega directo
  window.addEventListener('DOMContentLoaded', ()=>{
    const routeVisible = Array.from(document.querySelectorAll('.route')).find(r=> r.style.display!== 'none');
    if(routeVisible && routeVisible.id==='route-crm'){
      setupCrmTabs();
    }
  });

  // ========================== FIN BLOQUE 3 (CRM) ==========================
  // =============================================================
  //  BLOQUE 4: Proyectos & Tareas — Calendario + Gantt (sin libs)
  // =============================================================

  // ----------------------- Estado e inits -----------------------
  if(typeof state.projectSeq!=='number') state.projectSeq = 0;
  if(typeof state.taskSeq!=='number') state.taskSeq = 0;
  if(!Array.isArray(state.proyectos)) state.proyectos = [];
  if(!Array.isArray(state.tareas)) state.tareas = [];

  // datos demo si vacío
  if(state.proyectos.length===0){
    state.proyectos.push({
      id: ++state.projectSeq, nombre:'Implementación área frenos',
      inicio: toISO(addDays(new Date(), -10)), fin: toISO(addDays(new Date(), 15)),
      estado:'En curso', color:'#3dd6d0'
    });
    state.proyectos.push({
      id: ++state.projectSeq, nombre:'Campaña cambios de aceite',
      inicio: toISO(addDays(new Date(), -5)), fin: toISO(addDays(new Date(), 25)),
      estado:'Planificado', color:'#eab308'
    });
  }
  if(state.tareas.length===0){
    const p1 = state.proyectos[0].id, p2 = state.proyectos[1].id;
    state.tareas.push({ id: ++state.taskSeq, projectId:p1, nombre:'Cotizar repuestos', inicio: toISO(addDays(new Date(), -9)), fin: toISO(addDays(new Date(), -3)), avance: 100 });
    state.tareas.push({ id: ++state.taskSeq, projectId:p1, nombre:'Compra y recepción', inicio: toISO(addDays(new Date(), -2)), fin: toISO(addDays(new Date(), 4)), avance: 40 });
    state.tareas.push({ id: ++state.taskSeq, projectId:p1, nombre:'Instalación', inicio: toISO(addDays(new Date(), 5)), fin: toISO(addDays(new Date(), 12)), avance: 0 });
    state.tareas.push({ id: ++state.taskSeq, projectId:p2, nombre:'Diseño de piezas', inicio: toISO(addDays(new Date(), -3)), fin: toISO(addDays(new Date(), 6)), avance: 60 });
  }
  saveState();

  // seleccion actual de UI
  let selProjectId = state.proyectos[0]?.id || null;
  let calYear = new Date().getFullYear();
  let calMonth = new Date().getMonth()+1; // 1-12

  // acceso rápido
  const byId = (arr, id) => arr.find(x=>x.id===id);

  // ----------------------- Render principal -----------------------
  function ensureProyectosLayout(){
    const route = document.getElementById('route-proyectos');
    if(!route) return;

    // si el layout ya fue creado, no repetir
    if(route.dataset.enhanced==='1') return;

    // Construimos UI
    route.innerHTML = `
      <div class="row cols-3">
        <!-- Proyectos -->
        <div class="card" id="pjPanel">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
            <h3 style="margin:0">Proyectos</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn ok" id="btnAddProject">Añadir</button>
              <button class="btn ghost" onclick="exportTableCSV('tblProyectos','proyectos.csv')">CSV</button>
              <button class="btn ghost" onclick="printSection('route-proyectos')">Imprimir</button>
            </div>
          </div>
          <table id="tblProyectos" style="margin-top:10px">
            <thead><tr>
              <th>#</th><th>Nombre</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Acción</th>
            </tr></thead>
            <tbody id="pjBody"></tbody>
          </table>
        </div>

        <!-- Calendario -->
        <div class="card" id="calPanel">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
            <h3 style="margin:0">Calendario</h3>
            <div style="display:flex; gap:6px; flex-wrap:wrap">
              <select id="calYear"></select>
              <select id="calMonth"></select>
            </div>
          </div>
          <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px"></div>
          <div class="muted" style="margin-top:8px">* El calendario controla el rango visible del Gantt.</div>
        </div>

        <!-- Tareas + Gantt -->
        <div class="card" id="taskPanel">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
              <h3 style="margin:0">Tareas</h3>
              <span class="pill">Proyecto: <b id="pillProjectName">—</b></span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn ok" id="btnAddTask">Añadir tarea</button>
              <button class="btn ghost" onclick="exportTableCSV('tblTareas','tareas.csv')">CSV</button>
            </div>
          </div>

          <table id="tblTareas" style="margin-top:10px">
            <thead><tr>
              <th>#</th><th>Nombre</th><th>Inicio</th><th>Fin</th><th>Avance</th><th>Acción</th>
            </tr></thead>
            <tbody id="taskBody"></tbody>
          </table>

          <div style="margin-top:14px">
            <h3 style="margin:0 0 6px 0">Gantt</h3>
            <div class="chart-wrap"><canvas id="ganttCanvas" class="chart" width="1000" height="260"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Diálogos -->
      <dialog id="dlgProject">
        <form id="formProject" method="dialog" style="min-width:640px">
          <h3 id="dlgProjectTitle">Nuevo proyecto</h3>
          <div class="row" style="grid-template-columns:repeat(2,1fr)">
            <div><label>Nombre</label><input name="nombre" required></div>
            <div><label>Estado</label>
              <select name="estado"><option>Planificado</option><option>En curso</option><option>Completado</option></select>
            </div>
            <div><label>Inicio</label><input type="date" name="inicio" value="${todayISO()}" required></div>
            <div><label>Fin</label><input type="date" name="fin" value="${todayISO()}" required></div>
            <div class="span-2"><label>Color</label><input name="color" type="color" value="#3dd6d0"></div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
            <button class="btn ghost" value="cancel">Cancelar</button>
            <button class="btn" value="confirm">Guardar</button>
          </div>
        </form>
      </dialog>

      <dialog id="dlgTask">
        <form id="formTask" method="dialog" style="min-width:640px">
          <h3 id="dlgTaskTitle">Nueva tarea</h3>
          <div class="row" style="grid-template-columns:repeat(2,1fr)">
            <div class="span-2"><label>Nombre</label><input name="nombre" required></div>
            <div><label>Inicio</label><input type="date" name="inicio" value="${todayISO()}" required></div>
            <div><label>Fin</label><input type="date" name="fin" value="${todayISO()}" required></div>
            <div class="span-2"><label>Avance (%)</label><input type="number" name="avance" min="0" max="100" value="0"></div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
            <button class="btn ghost" value="cancel">Cancelar</button>
            <button class="btn" value="confirm">Guardar</button>
          </div>
        </form>
      </dialog>
    `;

    // combos calendario
    const ySel = route.querySelector('#calYear');
    const mSel = route.querySelector('#calMonth');
    ySel.innerHTML = Array.from({length:7},(_,i)=> {
      const y = calYear-3+i; return `<option value="${y}" ${y===calYear?'selected':''}>${y}</option>`;
    }).join('');
    mSel.innerHTML = monthNames.map((n,i)=> `<option value="${i+1}" ${i+1===calMonth?'selected':''}>${n}</option>`).join('');

    // eventos UI
    route.querySelector('#btnAddProject').addEventListener('click', ()=> openProjectDialog());
    route.querySelector('#btnAddTask').addEventListener('click', ()=> openTaskDialog());
    ySel.addEventListener('change', (e)=>{ calYear = Number(e.target.value); renderCalendar(); drawGantt(); });
    mSel.addEventListener('change', (e)=>{ calMonth = Number(e.target.value); renderCalendar(); drawGantt(); });

    route.dataset.enhanced='1';
  }

  // ----------------------- Proyectos (CRUD) -----------------------
  function renderProjectsTable(){
    const tbody = document.getElementById('pjBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    state.proyectos
      .slice()
      .sort((a,b)=> a.inicio<b.inicio?1:-1)
      .forEach((p,idx)=>{
        const tr = document.createElement('tr');
        tr.style.cursor='pointer';
        tr.innerHTML = `
          <td>${String(idx+1).padStart(2,'0')}</td>
          <td><span style="display:inline-flex; align-items:center; gap:6px"><span style="width:10px; height:10px; border-radius:50%; background:${p.color}; display:inline-block"></span>${p.nombre}</span></td>
          <td>${p.inicio}</td>
          <td>${p.fin}</td>
          <td>${p.estado}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap">
            <button class="btn ghost" onclick="editProject(${p.id})">Editar</button>
            <button class="btn bad" onclick="deleteProject(${p.id})">Eliminar</button>
          </td>
        `;
        tr.addEventListener('click', (ev)=>{
          // evitar que los botones disparen select
          if((ev.target.closest('button'))) return;
          selProjectId = p.id;
          renderTasksTable();
          setProjectPill();
          drawGantt();
        });
        if(p.id===selProjectId) tr.style.background='rgba(61,214,208,.08)';
        tbody.appendChild(tr);
      });
  }

  function setProjectPill(){
    const el = document.getElementById('pillProjectName');
    const p = byId(state.proyectos, selProjectId);
    if(el) el.textContent = p? p.nombre : '—';
  }

  function openProjectDialog(item){
    const dlg = document.getElementById('dlgProject');
    const form = document.getElementById('formProject');
    const title = document.getElementById('dlgProjectTitle');
    form.reset(); form.dataset.editId='';
    if(item){
      title.textContent='Editar proyecto';
      form.nombre.value=item.nombre; form.estado.value=item.estado;
      form.inicio.value=item.inicio; form.fin.value=item.fin;
      form.color.value=item.color || '#3dd6d0';
      form.dataset.editId=item.id;
    }else{
      title.textContent='Nuevo proyecto';
      form.inicio.value=todayISO(); form.fin.value=todayISO();
      form.color.value='#3dd6d0';
    }
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(form);
      const payload = {
        id: item? item.id : ++state.projectSeq,
        nombre: (fd.get('nombre')||'').trim(),
        inicio: fd.get('inicio'),
        fin: fd.get('fin'),
        estado: fd.get('estado'),
        color: fd.get('color') || '#3dd6d0'
      };
      if(!payload.nombre){ alert('Nombre requerido'); return; }
      // validación de fechas
      if(parseISO(payload.fin) < parseISO(payload.inicio)){ alert('Fin no puede ser anterior al inicio'); return; }
      if(item){
        state.proyectos = state.proyectos.map(p=> p.id===item.id? payload : p);
      }else{
        state.proyectos.push(payload);
        selProjectId = payload.id;
      }
      saveState();
      renderProjectsTable();
      renderTasksTable();
      setProjectPill();
      drawGantt();
    }, {once:true});
  }
  function editProject(id){ const p = byId(state.proyectos, id); if(p) openProjectDialog(p); }
  function deleteProject(id){
    if(!confirm('¿Eliminar proyecto y sus tareas?')) return;
    state.proyectos = state.proyectos.filter(p=>p.id!==id);
    state.tareas = state.tareas.filter(t=>t.projectId!==id);
    if(selProjectId===id) selProjectId = state.proyectos[0]?.id || null;
    saveState();
    renderProjectsTable();
    renderTasksTable();
    setProjectPill();
    drawGantt();
  }

  // ----------------------- Tareas (CRUD) -----------------------
  function tasksOfSelected(){
    return state.tareas.filter(t=> t.projectId===selProjectId)
      .slice().sort((a,b)=> a.inicio<b.inicio? -1 : 1);
  }
  function renderTasksTable(){
    const tbody = document.getElementById('taskBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const list = tasksOfSelected();
    list.forEach((t,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(idx+1).padStart(2,'0')}</td>
        <td>${t.nombre}</td>
        <td>${t.inicio}</td>
        <td>${t.fin}</td>
        <td>
          <div style="display:flex; align-items:center; gap:8px">
            <div style="flex:1; background:#0d1721; border:1px solid rgba(255,255,255,.08); height:8px; border-radius:999px; overflow:hidden">
              <div style="width:${Math.min(100,Math.max(0,Number(t.avance)))}%; height:100%; background:linear-gradient(90deg, var(--ok), #86efac)"></div>
            </div>
            <span class="muted" style="width:36px">${Math.min(100,Math.max(0,Number(t.avance)))}%</span>
          </div>
        </td>
        <td style="display:flex; gap:6px; flex-wrap:wrap">
          <button class="btn ghost" onclick="editTask(${t.id})">Editar</button>
          <button class="btn bad" onclick="deleteTask(${t.id})">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openTaskDialog(item){
    if(!selProjectId){ alert('Crea o selecciona un proyecto primero.'); return; }
    const dlg = document.getElementById('dlgTask');
    const form = document.getElementById('formTask');
    const title = document.getElementById('dlgTaskTitle');
    form.reset(); form.dataset.editId='';
    if(item){
      title.textContent='Editar tarea';
      form.nombre.value=item.nombre; form.inicio.value=item.inicio; form.fin.value=item.fin; form.avance.value=item.avance;
      form.dataset.editId=item.id;
    }else{
      title.textContent='Nueva tarea';
      form.inicio.value=todayISO(); form.fin.value=todayISO(); form.avance.value=0;
    }
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(form);
      const payload = {
        id: item? item.id : ++state.taskSeq,
        projectId: selProjectId,
        nombre: (fd.get('nombre')||'').trim(),
        inicio: fd.get('inicio'),
        fin: fd.get('fin'),
        avance: Number(fd.get('avance'))||0
      };
      if(!payload.nombre){ alert('Nombre requerido'); return; }
      if(parseISO(payload.fin) < parseISO(payload.inicio)){ alert('Fin no puede ser anterior al inicio'); return; }
      if(item){
        state.tareas = state.tareas.map(t=> t.id===item.id? payload : t);
      }else{
        state.tareas.push(payload);
      }
      saveState();
      renderTasksTable();
      drawGantt();
    }, {once:true});
  }
  function editTask(id){ const t = byId(state.tareas, id); if(t) openTaskDialog(t); }
  function deleteTask(id){
    if(!confirm('¿Eliminar tarea?')) return;
    state.tareas = state.tareas.filter(t=> t.id!==id);
    saveState();
    renderTasksTable();
    drawGantt();
  }

  // ----------------------- Calendario -----------------------
  function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); } // month 1-12
  function weekday(year, month, day){ return new Date(year, month-1, day).getDay(); } // 0-dom

  function renderCalendar(){
    const grid = document.getElementById('calendarGrid');
    if(!grid) return;
    grid.innerHTML = '';

    const headers = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
    headers.forEach(h=>{
      const hd = document.createElement('div');
      hd.textContent = h;
      hd.className = 'muted';
      hd.style.textAlign='center';
      grid.appendChild(hd);
    });

    const days = daysInMonth(calYear, calMonth);
    const firstWd = weekday(calYear, calMonth, 1); // 0..6
    // celdas en blanco antes del 1
    for(let i=0;i<firstWd;i++){
      const empty = document.createElement('div');
      empty.style.minHeight='42px';
      grid.appendChild(empty);
    }

    for(let d=1; d<=days; d++){
      const cell = document.createElement('div');
      cell.style.minHeight='42px';
      cell.style.border='1px dashed rgba(255,255,255,.08)';
      cell.style.borderRadius='10px';
      cell.style.padding='6px';
      cell.style.display='flex';
      cell.style.flexDirection='column';
      cell.style.gap='4px';
      const label = document.createElement('div');
      label.textContent = d;
      label.className='muted';
      grid.appendChild(cell);
      cell.appendChild(label);

      // chip con tareas que tocan ese día (sólo del proyecto seleccionado)
      const tasks = tasksOfSelected().filter(t => {
        const di = parseISO(t.inicio), df = parseISO(t.fin);
        const cur = new Date(calYear, calMonth-1, d);
        return cur>=di && cur<=df;
      }).slice(0,3); // mostrar hasta 3
      tasks.forEach(t=>{
        const chip = document.createElement('div');
        chip.textContent = t.nombre;
        chip.title = `${t.nombre} (${t.inicio} → ${t.fin})`;
        chip.style.fontSize='12px';
        chip.style.padding='2px 6px';
        chip.style.borderRadius='999px';
        chip.style.background='rgba(61,214,208,.18)';
        chip.style.border='1px solid rgba(61,214,208,.35)';
        cell.appendChild(chip);
      });
    }
  }

  // ----------------------- Gantt (Canvas) -----------------------
  function drawGantt(){
    const canvas = document.getElementById('ganttCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const left = 120, right = w-10, top = 20, bottom = h-30;
    const innerW = right-left, innerH = bottom-top;

    // rango del mes seleccionado
    const start = new Date(calYear, calMonth-1, 1);
    const end = new Date(calYear, calMonth, 0);
    const totalDays = (end - start)/(1000*60*60*24) + 1;

    // ejes + grid vertical por día
    ctx.strokeStyle='#294255';
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(left, top); ctx.lineTo(left, bottom); ctx.lineTo(right, bottom); ctx.stroke();

    ctx.strokeStyle='rgba(255,255,255,.08)';
    ctx.lineWidth=1;
    const stepX = innerW / totalDays;
    for(let i=0;i<totalDays;i++){
      const x = left + i*stepX;
      ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
    }

    // etiquetas de día (cada 2 o 3 días para no saturar)
    ctx.fillStyle='#9fb3c8';
    ctx.font='12px system-ui';
    const labelStep = totalDays>20? 3 : 2;
    for(let d=1; d<=totalDays; d+=labelStep){
      const x = left + (d-1)*stepX;
      ctx.fillText(String(d), x+2, h-10);
    }

    // proyecto color
    const project = byId(state.proyectos, selProjectId);
    const color = project?.color || '#3dd6d0';

    // filas de tareas
    const list = tasksOfSelected();
    const rowH = Math.max(16, Math.min(26, Math.floor(innerH/Math.max(1, list.length))));
    const rowGap = 8;
    const barH = Math.max(10, rowH-6);

    ctx.fillStyle='#cfe8ff';
    ctx.font='bold 14px system-ui';
    ctx.fillText(project? project.nombre : '—', 10, 18);

    list.forEach((t, idx)=>{
      const di = parseISO(t.inicio);
      const df = parseISO(t.fin);
      // recorte al mes visible
      const startClamped = di < start ? start : di;
      const endClamped = df > end ? end : df;

      const sIdx = Math.max(0, Math.floor((startClamped - start)/(1000*60*60*24)));
      const eIdx = Math.max(sIdx, Math.floor((endClamped - start)/(1000*60*60*24)));
      const x = left + sIdx*stepX + 1;
      const width = Math.max(2, (eIdx - sIdx + 1)*stepX - 2);
      const y = top + idx*(rowH+rowGap);

      // nombre de tarea
      ctx.fillStyle='#9fb3c8';
      ctx.font='12px system-ui';
      ctx.fillText(t.nombre, 10, y+barH);

      // barra fondo
      ctx.fillStyle='rgba(255,255,255,.06)';
      ctx.fillRect(x, y, width, barH);

      // barra progreso
      ctx.fillStyle=color;
      const progW = width * (Math.min(100,Math.max(0,Number(t.avance)))/100);
      ctx.fillRect(x, y, progW, barH);

      // borde
      ctx.strokeStyle='rgba(255,255,255,.25)';
      ctx.strokeRect(x, y, width, barH);
    });

    // leyenda progreso
    ctx.fillStyle='#cfe8ff';
    ctx.font='12px system-ui';
    ctx.fillText('Progreso = color sólido | Rango = rectángulo', left+6, top-6);
  }

  // ----------------------- Integración y arranque -----------------------
  function renderProyectosRoute(){
    ensureProyectosLayout();
    renderProjectsTable();
    renderTasksTable();
    setProjectPill();
    renderCalendar();
    drawGantt();
  }

  // Hook al router
  (function(){
    const _show = window.showRoute;
    window.showRoute = function(name){
      _show(name);
      if(name==='proyectos') renderProyectosRoute();
    }
  })();

  // Si el usuario abre directamente la ruta
  window.addEventListener('DOMContentLoaded', ()=>{
    const routeVisible = Array.from(document.querySelectorAll('.route')).find(r=> r.style.display!== 'none');
    if(routeVisible && routeVisible.id==='route-proyectos'){
      renderProyectosRoute();
    }
  });

  // ----------------------- Exponer helpers -----------------------
  window.microerp = Object.assign(window.microerp||{}, {
    renderProyectosRoute, drawGantt, renderCalendar
  });

  // =========================== FIN BLOQUE 4 ===========================
  // =============================================================
  //  BLOQUE 5: Apuntes (Intranet) — UI/UX enriquecido sin librerías
  // =============================================================

  // Estructura esperada en state.apuntes:
  // { pages: [{id, title, createdAt, updatedAt}], content: { [id]: "<html...>"} }

  // ----------------------- Utilidades -----------------------
  function uid() { return Math.random().toString(36).slice(2,9); }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function sanitizeHTML(html){
    // Sencillo sanitizado: quitar scripts/iframes/eventos (defensivo)
    const div = document.createElement('div');
    div.innerHTML = html;
    div.querySelectorAll('script, iframe').forEach(n=> n.remove());
    // remover atributos on*
    div.querySelectorAll('*').forEach(el=>{
      [...el.attributes].forEach(attr=>{
        if(/^on/i.test(attr.name)) el.removeAttribute(attr.name);
      });
    });
    return div.innerHTML;
  }

  // ----------------------- Layout dinámico -----------------------
  function ensureApuntesLayout(){
    const route = document.getElementById('route-apuntes');
    if(!route) return;
    if(route.dataset.enhanced==='1') return;

    route.innerHTML = `
      <div class="card" style="padding:0">
        <div style="display:grid; grid-template-columns:300px 1fr; min-height:540px">
          <!-- Panel izquierdo: páginas -->
          <aside id="notesSidebar" style="border-right:1px solid rgba(255,255,255,.06); display:flex; flex-direction:column; max-height:70vh">
            <div style="padding:12px; display:flex; gap:8px; align-items:center; border-bottom:1px solid rgba(255,255,255,.06)">
              <input id="noteSearch" placeholder="Buscar páginas…" style="flex:1">
              <button class="btn ok" id="btnNewNote">Nueva</button>
            </div>
            <div style="padding:8px; display:flex; gap:6px; flex-wrap:wrap; border-bottom:1px dashed rgba(255,255,255,.08)">
              <button class="btn ghost" id="tplMeeting">Plantilla: Reunión</button>
              <button class="btn ghost" id="tplService">Plantilla: Orden servicio</button>
              <button class="btn ghost" id="tplBlank">Plantilla: En blanco</button>
            </div>
            <div id="pagesList" style="overflow:auto; padding:8px"></div>
            <div style="margin-top:auto; padding:10px; border-top:1px solid rgba(255,255,255,.06); display:flex; gap:6px; flex-wrap:wrap">
              <button class="btn ghost" id="btnImport">Importar .md/.txt</button>
              <button class="btn ghost" id="btnExport">Exportar .md</button>
              <button class="btn ghost" onclick="printSection('route-apuntes')">Imprimir</button>
              <input type="file" id="fileImport" accept=".txt,.md" style="display:none">
            </div>
          </aside>

          <!-- Panel derecho: editor -->
          <section id="editorPanel" style="display:flex; flex-direction:column">
            <div id="editorToolbar" style="display:flex; gap:6px; flex-wrap:wrap; padding:10px; border-bottom:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02); position:sticky; top:0; z-index:1">
              <input id="noteTitle" placeholder="Título de la página…" style="flex:1; font-weight:800">
              <div class="pill">Autosave <span id="autosaveState">—</span></div>
            </div>

            <div style="padding:8px; display:flex; flex-wrap:wrap; gap:6px; border-bottom:1px dashed rgba(255,255,255,.06)">
              <button class="btn" data-cmd="bold"><b>B</b></button>
              <button class="btn" data-cmd="italic"><i>I</i></button>
              <button class="btn" data-cmd="underline"><u>U</u></button>
              <button class="btn ghost" data-block="h1">H1</button>
              <button class="btn ghost" data-block="h2">H2</button>
              <button class="btn ghost" data-list="ul">• Lista</button>
              <button class="btn ghost" data-list="ol">1. Lista</button>
              <button class="btn ghost" id="btnChecklist">☑ Checklist</button>
              <button class="btn ghost" id="btnQuote">“” Cita</button>
              <button class="btn ghost" id="btnCode">` + "`" + ` Código</button>
              <button class="btn warn" id="btnClearFormat">Limpiar formato</button>
              <div class="pill muted" id="wordCount">0 palabras</div>
            </div>

            <div id="noteMeta" class="muted" style="padding:6px 12px; font-size:12px">—</div>

            <div id="noteEditor"
              contenteditable="true"
              style="flex:1; padding:16px; outline:none; line-height:1.8; min-height:360px; font-size:15px">
              <!-- contenido de la página -->
            </div>

            <div style="display:flex; justify-content:flex-end; gap:6px; padding:10px; border-top:1px solid rgba(255,255,255,.06)">
              <button class="btn bad" id="btnDelete">Eliminar página</button>
              <button class="btn ghost" id="btnDuplicate">Duplicar</button>
              <button class="btn" id="btnSaveNow">Guardar ahora</button>
            </div>
          </section>
        </div>
      </div>
    `;
    route.dataset.enhanced='1';
  }

  // ----------------------- Estado y selección -----------------------
  let selectedNoteId = null;

  function notesEnsureState(){
    if(!state.apuntes) state.apuntes = { pages: [], content: {} };
    if(!Array.isArray(state.apuntes.pages)) state.apuntes.pages = [];
    if(typeof state.apuntes.content !== 'object') state.apuntes.content = {};
    // Crear demo si vacío
    if(state.apuntes.pages.length===0){
      const id = uid();
      state.apuntes.pages.push({ id, title:'Bienvenida', createdAt: new Date().toISOString(), updatedAt:new Date().toISOString() });
      state.apuntes.content[id] =
        `<h1>Bienvenido a Apuntes</h1>
         <p>Usa el panel izquierdo para crear, buscar, duplicar o eliminar páginas. El contenido se guarda automáticamente en tu navegador.</p>
         <ul><li>Negrita / Itálica / Subrayado</li><li>H1, H2</li><li>Listas y Checklist</li><li>Citas y código en línea</li></ul>`;
      saveState();
    }
  }

  // ----------------------- Render principal -----------------------
  function renderApuntes(){
    ensureApuntesLayout();
    notesEnsureState();
    renderPagesList();
    // Seleccionar la última usada o la primera
    if(!selectedNoteId){
      selectedNoteId = state.apuntes.pages[0]?.id || null;
    } else if(!state.apuntes.pages.find(p=>p.id===selectedNoteId)){
      selectedNoteId = state.apuntes.pages[0]?.id || null;
    }
    openNote(selectedNoteId);
    setupNotesEvents();
  }

  // ----------------------- Lista de páginas -----------------------
  function renderPagesList(filter=''){
    const list = document.getElementById('pagesList');
    if(!list) return;
    const q = filter.trim().toLowerCase();
    const data = state.apuntes.pages
      .slice()
      .sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt))
      .filter(p=> !q || p.title.toLowerCase().includes(q));

    list.innerHTML = '';
    data.forEach(p=>{
      const item = document.createElement('div');
      item.style.padding='10px';
      item.style.border='1px solid rgba(255,255,255,.06)';
      item.style.borderRadius='10px';
      item.style.marginBottom='8px';
      item.style.cursor='pointer';
      item.style.background = p.id===selectedNoteId ? 'rgba(61,214,208,.12)' : 'transparent';
      item.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:8px; align-items:center">
          <div style="display:flex; gap:8px; align-items:center">
            <div style="width:8px; height:8px; border-radius:999px; background:${p.id===selectedNoteId?'var(--pri)':'rgba(255,255,255,.2)'}"></div>
            <div style="font-weight:700">${p.title}</div>
          </div>
          <div class="muted" style="font-size:12px">${new Date(p.updatedAt||p.createdAt).toLocaleString('es-PE',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'})}</div>
        </div>
        <div style="display:flex; gap:6px; margin-top:8px">
          <button class="btn ghost" data-action="rename" data-id="${p.id}">Renombrar</button>
          <button class="btn ghost" data-action="duplicate" data-id="${p.id}">Duplicar</button>
          <button class="btn bad" data-action="delete" data-id="${p.id}">Eliminar</button>
        </div>
      `;
      item.addEventListener('click', (e)=>{
        if(e.target.closest('button')) return; // botones tienen su handler aparte
        selectedNoteId = p.id;
        openNote(p.id);
        renderPagesList(q);
      });
      list.appendChild(item);
    });

    if(data.length===0){
      const empty = document.createElement('div');
      empty.className='muted';
      empty.style.padding='10px';
      empty.textContent='Sin resultados.';
      list.appendChild(empty);
    }
  }

  // ----------------------- Abrir/crear/renombrar/eliminar -----------------------
  function newNote(template='blank'){
    const id = uid();
    const now = new Date().toISOString();
    let title = 'Nueva página';
    let body = '<p>Escribe aquí…</p>';

    if(template==='meeting'){
      title = 'Reunión — ' + new Date().toLocaleDateString('es-PE');
      body = `<h1>Reunión: ${new Date().toLocaleDateString('es-PE')}</h1>
      <h2>Participantes</h2><ul><li>—</li></ul>
      <h2>Temas</h2><ul><li>—</li></ul>
      <h2>Acuerdos</h2><ul><li>[ ] Responsable — Fecha</li></ul>`;
    } else if(template==='service'){
      title = 'Orden de servicio';
      body = `<h1>Orden de servicio</h1>
      <p><b>Cliente:</b> — &nbsp;&nbsp; <b>Vehículo:</b> — &nbsp;&nbsp; <b>Placa:</b> —</p>
      <h2>Diagnóstico</h2><p>—</p>
      <h2>Trabajo a realizar</h2><ul><li>—</li></ul>
      <h2>Repuestos utilizados</h2><table><tr><th>Cod</th><th>Nombre</th><th>Cant</th></tr><tr><td>—</td><td>—</td><td>—</td></tr></table>
      <h2>Firma</h2><p>_____________________</p>`;
    }

    state.apuntes.pages.push({ id, title, createdAt: now, updatedAt: now });
    state.apuntes.content[id] = body;
    saveState();
    selectedNoteId = id;
    renderPagesList();
    openNote(id);
  }

  function openNote(id){
    const page = state.apuntes.pages.find(p=>p.id===id);
    const editor = document.getElementById('noteEditor');
    const title = document.getElementById('noteTitle');
    const meta = document.getElementById('noteMeta');
    if(!page || !editor || !title) return;

    title.value = page.title;
    editor.innerHTML = state.apuntes.content[id] || '<p></p>';
    meta.textContent = `Creada: ${new Date(page.createdAt).toLocaleString('es-PE')} · Actualizada: ${new Date(page.updatedAt||page.createdAt).toLocaleString('es-PE')}`;
    updateWordCount();
    // Reset estado autosave
    setAutosaveState('—');
  }

  function renameNote(id){
    const page = state.apuntes.pages.find(p=>p.id===id);
    if(!page) return;
    const name = prompt('Nuevo título:', page.title);
    if(!name) return;
    page.title = name.trim() || page.title;
    page.updatedAt = new Date().toISOString();
    saveState();
    renderPagesList(document.getElementById('noteSearch').value || '');
    if(id===selectedNoteId) document.getElementById('noteTitle').value = page.title;
  }

  function duplicateNote(id){
    const page = state.apuntes.pages.find(p=>p.id===id);
    if(!page) return;
    const newId = uid();
    const now = new Date().toISOString();
    state.apuntes.pages.push({ id:newId, title: page.title + ' (copia)', createdAt: now, updatedAt: now });
    state.apuntes.content[newId] = state.apuntes.content[id];
    saveState();
    selectedNoteId = newId;
    renderPagesList();
    openNote(newId);
  }

  function deleteNote(id){
    if(!confirm('¿Eliminar esta página?')) return;
    state.apuntes.pages = state.apuntes.pages.filter(p=>p.id!==id);
    delete state.apuntes.content[id];
    saveState();
    selectedNoteId = state.apuntes.pages[0]?.id || null;
    renderPagesList();
    openNote(selectedNoteId);
  }

  // ----------------------- Toolbar acciones -----------------------
  function exec(cmd, val=null){
    document.execCommand(cmd, false, val);
  }
  function toggleBlock(tag){
    // Aplica block H1/H2 o párrafo
    if(tag==='h1' || tag==='h2') document.execCommand('formatBlock', false, tag.toUpperCase());
  }
  function toggleList(type){
    if(type==='ul') exec('insertUnorderedList');
    if(type==='ol') exec('insertOrderedList');
  }
  function insertQuote(){
    document.execCommand('formatBlock', false, 'blockquote');
  }
  function insertInlineCode(){
    // reemplaza selección por <code>..</code> sencillo
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const range = sel.getRangeAt(0);
    const span = document.createElement('code');
    span.textContent = sel.toString();
    range.deleteContents();
    range.insertNode(span);
    // mover cursor al final
    sel.removeAllRanges();
    const r = document.createRange();
    r.selectNodeContents(span);
    r.collapse(false);
    sel.addRange(r);
  }
  function insertChecklist(){
    // Inserta UL con elementos [ ] personalizables visualmente
    exec('insertUnorderedList');
    // marcar clase checklist al bloque actual
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const li = sel.anchorNode.closest('li');
    if(li && li.parentElement){
      li.parentElement.dataset.checklist = '1';
      // toggling con click
      li.parentElement.addEventListener('click', (e)=>{
        const target = e.target.closest('li');
        if(!target) return;
        target.dataset.checked = target.dataset.checked==='1' ? '0' : '1';
      }, {once:true});
    }
  }
  function clearFormat(){
    exec('removeFormat');
    // quitar bloques especiales
    document.execCommand('formatBlock', false, 'p');
  }

  // ----------------------- Autosave / palabraje -----------------------
  const debouncedSave = debounce(()=> saveCurrentNote(), 600);

  function saveCurrentNote(force=false){
    if(!selectedNoteId) return;
    const title = document.getElementById('noteTitle').value.trim() || 'Sin título';
    const html = sanitizeHTML(document.getElementById('noteEditor').innerHTML);
    const page = state.apuntes.pages.find(p=>p.id===selectedNoteId);
    if(!page) return;

    // Solo guardar si hay cambios
    const changed = (state.apuntes.content[selectedNoteId]!==html) || (page.title!==title) || force;
    if(!changed) return;

    page.title = title;
    page.updatedAt = new Date().toISOString();
    state.apuntes.content[selectedNoteId] = html;
    saveState();
    setAutosaveState('✓ guardado');
    renderPagesList(document.getElementById('noteSearch').value || '');
  }

  function setAutosaveState(text){
    const el = document.getElementById('autosaveState');
    if(el){ el.textContent = text; el.style.opacity = .9; setTimeout(()=> el.style.opacity=.5, 800); }
  }

  function updateWordCount(){
    const t = document.getElementById('noteEditor').innerText || '';
    const words = (t.trim().match(/\\S+/g)||[]).length;
    const wc = document.getElementById('wordCount');
    if(wc) wc.textContent = words+' palabras';
  }

  // ----------------------- Exportar / Importar -----------------------
  function exportCurrentNoteMD(){
    if(!selectedNoteId) return;
    const page = state.apuntes.pages.find(p=>p.id===selectedNoteId);
    const html = state.apuntes.content[selectedNoteId] || '';
    // Conversión mínima HTML->texto MD-like (simple)
    let text = html
      .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
      .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
      .replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gi, '> $1\n\n')
      .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<[^>]+>/g, '')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
    
    const blob = new Blob([text], {type:'text/markdown;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=(page.title||'nota')+'.md'; a.click(); URL.revokeObjectURL(url);
}

  function importNoteFromFile(file){
    const reader = new FileReader();
    reader.onload = () =>{
      const raw = String(reader.result || '');
      // envolver como párrafos sencillos
      const html = raw
        .split(/\\n\\n+/).map(p=> `<p>${p.replace(/\\n/g,'<br>')}</p>`).join('');
      const id = uid();
      const now = new Date().toISOString();
      state.apuntes.pages.push({ id, title: (file.name||'importado').replace(/\\.(md|txt)$/i,''), createdAt:now, updatedAt:now });
      state.apuntes.content[id] = html;
      saveState();
      selectedNoteId = id;
      renderPagesList();
      openNote(id);
    };
    reader.readAsText(file);
  }

  // ----------------------- Eventos de UI -----------------------
  function setupNotesEvents(){
    const route = document.getElementById('route-apuntes');
    if(!route) return;

    // Búsqueda
    const search = document.getElementById('noteSearch');
    if(search && !search.dataset.bound){
      search.dataset.bound='1';
      search.addEventListener('input', (e)=> renderPagesList(e.target.value));
    }

    // Botones crear por plantilla
    const btnNew = document.getElementById('btnNewNote');
    const btnM = document.getElementById('tplMeeting');
    const btnS = document.getElementById('tplService');
    const btnB = document.getElementById('tplBlank');
    if(btnNew && !btnNew.dataset.bound){ btnNew.dataset.bound='1'; btnNew.addEventListener('click', ()=> newNote('blank')); }
    if(btnM && !btnM.dataset.bound){ btnM.dataset.bound='1'; btnM.addEventListener('click', ()=> newNote('meeting')); }
    if(btnS && !btnS.dataset.bound){ btnS.dataset.bound='1'; btnS.addEventListener('click', ()=> newNote('service')); }
    if(btnB && !btnB.dataset.bound){ btnB.dataset.bound='1'; btnB.addEventListener('click', ()=> newNote('blank')); }

    // Acciones en lista (delegación)
    const pagesList = document.getElementById('pagesList');
    if(pagesList && !pagesList.dataset.bound){
      pagesList.dataset.bound='1';
      pagesList.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const id = btn.dataset.id;
        if(btn.dataset.action==='rename') renameNote(id);
        if(btn.dataset.action==='duplicate') duplicateNote(id);
        if(btn.dataset.action==='delete') deleteNote(id);
      });
    }

    // Título y editor: autosave
    const title = document.getElementById('noteTitle');
    const editor = document.getElementById('noteEditor');
    if(title && !title.dataset.bound){
      title.dataset.bound='1';
      title.addEventListener('input', ()=> { setAutosaveState('…'); debouncedSave(); });
    }
    if(editor && !editor.dataset.bound){
      editor.dataset.bound='1';
      editor.addEventListener('input', ()=> { setAutosaveState('…'); debouncedSave(); updateWordCount(); });
      editor.addEventListener('keydown', (e)=>{
        // Atajos simples
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveCurrentNote(true); }
      });
    }

    // Toolbar básica
    document.querySelectorAll('#editorPanel [data-cmd]').forEach(b=>{
      if(b.dataset.bound) return; b.dataset.bound='1';
      b.addEventListener('click', ()=> exec(b.dataset.cmd));
    });
    document.querySelectorAll('#editorPanel [data-block]').forEach(b=>{
      if(b.dataset.bound) return; b.dataset.bound='1';
      b.addEventListener('click', ()=> toggleBlock(b.dataset.block));
    });
    document.querySelectorAll('#editorPanel [data-list]').forEach(b=>{
      if(b.dataset.bound) return; b.dataset.bound='1';
      b.addEventListener('click', ()=> toggleList(b.dataset.list));
    });

    const btnChecklist = document.getElementById('btnChecklist');
    const btnQuote = document.getElementById('btnQuote');
    const btnCode = document.getElementById('btnCode');
    const btnClear = document.getElementById('btnClearFormat');
    const btnSaveNow = document.getElementById('btnSaveNow');
    const btnDelete = document.getElementById('btnDelete');
    const btnDup = document.getElementById('btnDuplicate');

    if(btnChecklist && !btnChecklist.dataset.bound){ btnChecklist.dataset.bound='1'; btnChecklist.addEventListener('click', insertChecklist); }
    if(btnQuote && !btnQuote.dataset.bound){ btnQuote.dataset.bound='1'; btnQuote.addEventListener('click', insertQuote); }
    if(btnCode && !btnCode.dataset.bound){ btnCode.dataset.bound='1'; btnCode.addEventListener('click', insertInlineCode); }
    if(btnClear && !btnClear.dataset.bound){ btnClear.dataset.bound='1'; btnClear.addEventListener('click', clearFormat); }
    if(btnSaveNow && !btnSaveNow.dataset.bound){ btnSaveNow.dataset.bound='1'; btnSaveNow.addEventListener('click', ()=> saveCurrentNote(true)); }
    if(btnDelete && !btnDelete.dataset.bound){ btnDelete.dataset.bound='1'; btnDelete.addEventListener('click', ()=> deleteNote(selectedNoteId)); }
    if(btnDup && !btnDup.dataset.bound){ btnDup.dataset.bound='1'; btnDup.addEventListener('click', ()=> duplicateNote(selectedNoteId)); }

    // Export / Import
    const btnExp = document.getElementById('btnExport');
    const btnImp = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileImport');
    if(btnExp && !btnExp.dataset.bound){ btnExp.dataset.bound='1'; btnExp.addEventListener('click', exportCurrentNoteMD); }
    if(btnImp && !btnImp.dataset.bound){ btnImp.dataset.bound='1'; btnImp.addEventListener('click', ()=> fileInput.click()); }
    if(fileInput && !fileInput.dataset.bound){
      fileInput.dataset.bound='1';
      fileInput.addEventListener('change', (e)=> {
        const f = e.target.files?.[0];
        if(f) importNoteFromFile(f);
        fileInput.value='';
      });
    }
  }

  // ----------------------- Integración con router -----------------------
  (function(){
    const _show = window.showRoute;
    window.showRoute = function(name){
      _show(name);
      if(name==='apuntes') renderApuntes();
    }
  })();

  // Carga directa si el usuario cae en Apuntes
  window.addEventListener('DOMContentLoaded', ()=>{
    const routeVisible = Array.from(document.querySelectorAll('.route')).find(r=> r.style.display!== 'none');
    if(routeVisible && routeVisible.id==='route-apuntes'){
      renderApuntes();
    }
  });

  // =========================== FIN BLOQUE 5 ===========================
  // =============================================================
  //  BLOQUE 6: RR.HH. — Empleados, Ausencias, Turnos, Evaluaciones,
  //             Organigrama y Onboarding (sin librerías)
  // =============================================================

  // ---------- Estado base y datos demo ----------
  if(!state.rrhh) state.rrhh = { empleados:[], ausencias:[], turnos:[], evaluaciones:[], onboarding:[] };
  if(!Array.isArray(state.rrhh.empleados)) state.rrhh.empleados=[];
  if(!Array.isArray(state.rrhh.ausencias)) state.rrhh.ausencias=[];
  if(!Array.isArray(state.rrhh.turnos)) state.rrhh.turnos=[];
  if(!Array.isArray(state.rrhh.evaluaciones)) state.rrhh.evaluaciones=[];
  if(!Array.isArray(state.rrhh.onboarding)) state.rrhh.onboarding=[];

  if(typeof state.empSeq!=='number') state.empSeq=0;
  if(typeof state.absSeq!=='number') state.absSeq=0;
  if(typeof state.shiftSeq!=='number') state.shiftSeq=0;
  if(typeof state.evalSeq!=='number') state.evalSeq=0;
  if(typeof state.todoSeq!=='number') state.todoSeq=0;

  // Seed si está vacío
  if(state.rrhh.empleados.length===0){
    state.rrhh.empleados.push(
      { id: ++state.empSeq, nombre:'Ana Flores', cargo:'Administración', email:'ana@empresa.com', telefono:'999111222', ingreso: toISO(addDays(new Date(), -120)), sueldo: 2500, managerId:null },
      { id: ++state.empSeq, nombre:'Carlos Ruiz', cargo:'Jefe Taller', email:'carlos@empresa.com', telefono:'999333444', ingreso: toISO(addDays(new Date(), -300)), sueldo: 3500, managerId:null },
      { id: ++state.empSeq, nombre:'Diana Soto', cargo:'Mecánico', email:'diana@empresa.com', telefono:'988777666', ingreso: toISO(addDays(new Date(), -60)), sueldo: 1800, managerId: state.rrhh.empleados[1].id }
    );
    state.rrhh.ausencias.push(
      { id: ++state.absSeq, empId: state.rrhh.empleados[2].id, desde: toISO(addDays(new Date(), -5)), hasta: toISO(addDays(new Date(), -3)), tipo:'Vacaciones', motivo:'—' }
    );
    state.rrhh.turnos.push(
      { id: ++state.shiftSeq, empId: state.rrhh.empleados[2].id, fecha: toISO(new Date()), inicio:'09:00', fin:'18:00' }
    );
    state.rrhh.evaluaciones.push(
      { id: ++state.evalSeq, empId: state.rrhh.empleados[2].id, fecha: toISO(addDays(new Date(), -7)), puntaje: 4, comentarios:'Buen desempeño.' }
    );
    state.rrhh.onboarding.push(
      { id: ++state.todoSeq, empId: state.rrhh.empleados[2].id, texto:'Entregar documentos', done:true },
      { id: ++state.todoSeq, empId: state.rrhh.empleados[2].id, texto:'Capacitación seguridad', done:false }
    );
    saveState();
  }

  // ---------- Helpers ----------
  function empName(id){ const e = state.rrhh.empleados.find(x=>x.id===id); return e? e.nombre : '—'; }
  function empOptions(selectedId){
    return ['<option value="">— Seleccionar —</option>']
      .concat(state.rrhh.empleados.map(e=> `<option value="${e.id}" ${selectedId===e.id?'selected':''}>${e.nombre}</option>`))
      .join('');
  }

  // ---------- Layout principal RR.HH. ----------
  function ensureRRHHLayout(){
    const route = document.getElementById('route-rrhh');
    if(!route || route.dataset.enhanced==='1') return;
    route.innerHTML = `
      <div class="card" style="padding:0; background:transparent; border:none">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px">
          <div>
            <h3 style="margin:0">RR.HH.</h3>
            <div class="muted" style="font-size:12px">Gestión de empleados, ausencias, turnos, evaluaciones, organigrama y onboarding.</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn ghost" onclick="exportTableCSV(rrhhCurrentTableId(),'rrhh.csv')">Exportar CSV</button>
            <button class="btn ghost" onclick="printSection('route-rrhh')">Imprimir</button>
          </div>
        </div>
        <div class="tabs" id="rrhhTabs" style="padding:0 12px 12px">
          <button class="active" data-tab="empleados">Empleados</button>
          <button data-tab="ausencias">Ausencias</button>
          <button data-tab="turnos">Turnos</button>
          <button data-tab="evaluaciones">Evaluaciones</button>
          <button data-tab="organigrama">Organigrama</button>
          <button data-tab="onboarding">Onboarding</button>
        </div>
        <div id="rrhhContent" class="card" style="margin:0 12px 12px; min-height:420px"></div>
      </div>

      <!-- Diálogos -->
      <dialog id="dlgEmpleado">
        <form id="formEmpleado" method="dialog" style="min-width:740px">
          <h3 id="dlgEmpTitle">Nuevo empleado</h3>
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div><label>Nombre</label><input name="nombre" required></div>
            <div><label>Cargo</label><input name="cargo" required></div>
            <div><label>Email</label><input name="email" type="email"></div>
            <div><label>Teléfono</label><input name="telefono"></div>
            <div><label>Ingreso</label><input name="ingreso" type="date" value="${todayISO()}"></div>
            <div><label>Sueldo (S/)</label><input name="sueldo" type="number" step="0.01" value="0"></div>
            <div class="span-3"><label>Manager</label><select name="managerId"></select></div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
            <button class="btn ghost" value="cancel">Cancelar</button>
            <button class="btn" value="confirm">Guardar</button>
          </div>
        </form>
      </dialog>

      <dialog id="dlgAusencia">
        <form id="formAusencia" method="dialog" style="min-width:640px">
          <h3 id="dlgAbsTitle">Nueva ausencia</h3>
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div><label>Empleado</label><select name="empId">${empOptions()}</select></div>
            <div><label>Desde</label><input name="desde" type="date" value="${todayISO()}"></div>
            <div><label>Hasta</label><input name="hasta" type="date" value="${todayISO()}"></div>
            <div><label>Tipo</label><select name="tipo"><option>Vacaciones</option><option>Permiso</option><option>Licencia</option><option>Incapacidad</option></select></div>
            <div class="span-3"><label>Motivo</label><input name="motivo"></div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
            <button class="btn ghost" value="cancel">Cancelar</button>
            <button class="btn" value="confirm">Guardar</button>
          </div>
        </form>
      </dialog>

      <dialog id="dlgTurno">
        <form id="formTurno" method="dialog" style="min-width:620px">
          <h3 id="dlgTurnoTitle">Nuevo turno</h3>
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div><label>Empleado</label><select name="empId">${empOptions()}</select></div>
            <div><label>Fecha</label><input name="fecha" type="date" value="${todayISO()}"></div>
            <div><label>Inicio</label><input name="inicio" type="time" value="09:00"></div>
            <div><label>Fin</label><input name="fin" type="time" value="18:00"></div>
            <div class="span-3"><label>Notas</label><input name="notas"></div>
          </div>
          <div class="right" style="display:flex; gap:8px; margin-top:12px">
            <button class="btn ghost" value="cancel">Cancelar</button>
            <button class="btn" value="confirm">Guardar</button>
          </div>
        </form>
      </dialog>

      <dialog id="dlgEval">
        <form id="formEval" method="dialog" style="min-width:620px">
          <h3 id="dlgEvalTitle">Nueva evaluación</h3>
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div><label>Empleado</label><select name="empId">${empOptions()}</select></div>
            <div><label>Fecha</label><input name="fecha" type="date" value="${todayISO()}"></div>
            <div><label>Puntaje (1–5)</label><input name="puntaje" type="number" min="1" max="5" value="3"></div>
            <div class="span-3"><label>Comentarios</label><textarea name="comentarios" style="min-height:80px"></textarea></div>
          </div>
          <div class="right" style="display:flex; gap:8px; margin-top:12px">
            <button class="btn ghost" value="cancel">Cancelar</button>
            <button class="btn" value="confirm">Guardar</button>
          </div>
        </form>
      </dialog>
    `;
    route.dataset.enhanced='1';
  }

  // ---------- Control de tabs ----------
  function rrhhBindTabs(){
    const tabs = document.getElementById('rrhhTabs');
    const content = document.getElementById('rrhhContent');
    if(!tabs || !content) return;
    tabs.querySelectorAll('button').forEach(btn=>{
      if(btn.dataset.bound) return; btn.dataset.bound='1';
      btn.addEventListener('click', ()=>{
        tabs.querySelectorAll('button').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        renderRRHHTab(btn.dataset.tab);
      });
    });
    renderRRHHTab('empleados');
  }
  function renderRRHHTab(key){
    if(key==='empleados') renderEmpleados();
    else if(key==='ausencias') renderAusencias();
    else if(key==='turnos') renderTurnos();
    else if(key==='evaluaciones') renderEvaluaciones();
    else if(key==='organigrama') renderOrganigrama();
    else renderOnboarding();
  }
  function rrhhCurrentTableId(){
    const active = document.querySelector('#rrhhTabs button.active')?.dataset.tab;
    switch(active){
      case 'empleados': return 'tblEmpleados';
      case 'ausencias': return 'tblAusencias';
      case 'turnos': return 'tblTurnos';
      case 'evaluaciones': return 'tblEvaluaciones';
      case 'onboarding': return 'tblOnboarding';
      default: return 'tblEmpleados';
    }
  }

  // =============================================================
  //  Empleados
  // =============================================================
  function renderEmpleados(){
    const content = document.getElementById('rrhhContent');
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; align-items:center">
          <h3 style="margin:0">Empleados</h3>
          <span class="pill muted">Total: ${state.rrhh.empleados.length}</span>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn ok" id="btnAddEmp">Añadir</button>
        </div>
      </div>
      <table id="tblEmpleados">
        <thead><tr>
          <th>#</th><th>Nombre</th><th>Cargo</th><th>Email</th><th>Teléfono</th><th>Ingreso</th><th>Sueldo</th><th>Manager</th><th>Acción</th>
        </tr></thead>
        <tbody id="empBody"></tbody>
      </table>
    `;
    const tbody = document.getElementById('empBody');
    state.rrhh.empleados
      .slice()
      .sort((a,b)=> a.nombre.localeCompare(b.nombre))
      .forEach((e,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${String(i+1).padStart(2,'0')}</td>
          <td>${e.nombre}</td>
          <td>${e.cargo||'—'}</td>
          <td>${e.email||'—'}</td>
          <td>${e.telefono||'—'}</td>
          <td>${e.ingreso||'—'}</td>
          <td>${fmt.format(Number(e.sueldo)||0)}</td>
          <td>${e.managerId? empName(e.managerId): '—'}</td>
          <td style="display:flex; gap:6px; flex-wrap:wrap">
            <button class="btn ghost" onclick="editEmpleado(${e.id})">Editar</button>
            <button class="btn bad" onclick="deleteEmpleado(${e.id})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    document.getElementById('btnAddEmp').addEventListener('click', ()=> openEmpleadoDialog());
  }

  function openEmpleadoDialog(item){
    const dlg = document.getElementById('dlgEmpleado');
    const form = document.getElementById('formEmpleado');
    const title = document.getElementById('dlgEmpTitle');
    // Rellenar managers
    form.managerId.innerHTML = ['<option value="">— Ninguno —</option>']
      .concat(state.rrhh.empleados.map(e=> `<option value="${e.id}" ${item?.managerId===e.id?'selected':''}>${e.nombre}</option>`)).join('');
    if(item){
      title.textContent='Editar empleado';
      form.nombre.value=item.nombre; form.cargo.value=item.cargo||''; form.email.value=item.email||'';
      form.telefono.value=item.telefono||''; form.ingreso.value=item.ingreso||todayISO();
      form.sueldo.value=item.sueldo||0; form.managerId.value=item.managerId||'';
      form.dataset.editId=item.id;
    }else{
      title.textContent='Nuevo empleado';
      form.reset(); form.ingreso.value=todayISO(); form.dataset.editId='';
    }
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(form);
      const payload = {
        id: item? item.id : ++state.empSeq,
        nombre: (fd.get('nombre')||'').trim(),
        cargo: (fd.get('cargo')||'').trim(),
        email: (fd.get('email')||'').trim(),
        telefono: (fd.get('telefono')||'').trim(),
        ingreso: fd.get('ingreso'),
        sueldo: Number(fd.get('sueldo'))||0,
        managerId: fd.get('managerId')? Number(fd.get('managerId')): null
      };
      if(!payload.nombre){ alert('Nombre requerido'); return; }
      if(item){
        state.rrhh.empleados = state.rrhh.empleados.map(e=> e.id===item.id? payload : e);
      }else{
        state.rrhh.empleados.push(payload);
      }
      saveState();
      renderEmpleados();
    }, {once:true});
  }
  function editEmpleado(id){ const e = state.rrhh.empleados.find(x=>x.id===id); if(e) openEmpleadoDialog(e); }
  function deleteEmpleado(id){
    if(!confirm('¿Eliminar empleado y sus registros asociados?')) return;
    state.rrhh.empleados = state.rrhh.empleados.filter(e=> e.id!==id);
    state.rrhh.ausencias = state.rrhh.ausencias.filter(a=> a.empId!==id);
    state.rrhh.turnos = state.rrhh.turnos.filter(t=> t.empId!==id);
    state.rrhh.evaluaciones = state.rrhh.evaluaciones.filter(v=> v.empId!==id);
    state.rrhh.onboarding = state.rrhh.onboarding.filter(o=> o.empId!==id);
    saveState(); renderEmpleados();
  }

  // =============================================================
  //  Ausencias
  // =============================================================
  function renderAusencias(){
    const content = document.getElementById('rrhhContent');
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; align-items:center">
          <h3 style="margin:0">Ausencias</h3>
          <select id="absEmpFilter" style="min-width:220px">${empOptions('')}</select>
          <span class="pill muted">Total: ${state.rrhh.ausencias.length}</span>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn ok" id="btnAddAbs">Añadir</button>
        </div>
      </div>
      <table id="tblAusencias">
        <thead><tr>
          <th>#</th><th>Empleado</th><th>Desde</th><th>Hasta</th><th>Días</th><th>Tipo</th><th>Motivo</th><th>Acción</th>
        </tr></thead>
        <tbody id="absBody"></tbody>
      </table>
    `;
    const filter = document.getElementById('absEmpFilter');
    filter.addEventListener('change', ()=> fillAbsTable(filter.value? Number(filter.value): null));
    document.getElementById('btnAddAbs').addEventListener('click', ()=> openAusenciaDialog());
    fillAbsTable(null);
  }
  function fillAbsTable(empId){
    const tbody = document.getElementById('absBody');
    tbody.innerHTML='';
    let list = state.rrhh.ausencias.slice().sort((a,b)=> a.desde<b.desde?1:-1);
    if(empId) list = list.filter(a=> a.empId===empId);
    list.forEach((a,i)=>{
      const dias = Math.max(1, Math.round((parseISO(a.hasta)-parseISO(a.desde))/(1000*60*60*24))+1);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td>${empName(a.empId)}</td>
        <td>${a.desde}</td>
        <td>${a.hasta}</td>
        <td>${dias}</td>
        <td>${a.tipo}</td>
        <td><details><summary>Ver</summary>${a.motivo||'—'}</details></td>
        <td style="display:flex; gap:6px; flex-wrap:wrap">
          <button class="btn ghost" onclick="editAusencia(${a.id})">Editar</button>
          <button class="btn bad" onclick="deleteAusencia(${a.id})">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function openAusenciaDialog(item){
    const dlg = document.getElementById('dlgAusencia');
    const form = document.getElementById('formAusencia');
    const title = document.getElementById('dlgAbsTitle');
    // actualizar opciones empleado
    form.empId.innerHTML = empOptions(item?.empId || '');
    if(item){
      title.textContent='Editar ausencia';
      form.empId.value=item.empId; form.desde.value=item.desde; form.hasta.value=item.hasta;
      form.tipo.value=item.tipo; form.motivo.value=item.motivo||'';
    }else{
      title.textContent='Nueva ausencia';
      form.reset(); form.desde.value=todayISO(); form.hasta.value=todayISO();
    }
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(form);
      const payload = {
        id: item? item.id : ++state.absSeq,
        empId: Number(fd.get('empId')),
        desde: fd.get('desde'),
        hasta: fd.get('hasta'),
        tipo: fd.get('tipo'),
        motivo: (fd.get('motivo')||'').trim()
      };
      if(!payload.empId){ alert('Selecciona un empleado'); return; }
      if(parseISO(payload.hasta) < parseISO(payload.desde)){ alert('Rango de fechas inválido'); return; }
      if(item){
        state.rrhh.ausencias = state.rrhh.ausencias.map(a=> a.id===item.id? payload : a);
      }else{
        state.rrhh.ausencias.push(payload);
      }
      saveState(); renderAusencias();
    }, {once:true});
  }
  function editAusencia(id){ const a = state.rrhh.ausencias.find(x=>x.id===id); if(a) openAusenciaDialog(a); }
  function deleteAusencia(id){
    if(!confirm('¿Eliminar ausencia?')) return;
    state.rrhh.ausencias = state.rrhh.ausencias.filter(a=> a.id!==id);
    saveState(); renderAusencias();
  }

  // =============================================================
  //  Turnos
  // =============================================================
  function renderTurnos(){
    const content = document.getElementById('rrhhContent');
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <h3 style="margin:0">Turnos</h3>
          <select id="turnEmpFilter" style="min-width:220px">${empOptions('')}</select>
          <input id="turnWeek" type="week" value="${new Date().getFullYear()}-W${String(Math.ceil(( (new Date()-new Date(new Date().getFullYear(),0,1)) / 86400000 + new Date(new Date().getFullYear(),0,1).getDay()+1)/7)).padStart(2,'0')}" />
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn ok" id="btnAddTurno">Añadir</button>
        </div>
      </div>
      <table id="tblTurnos">
        <thead><tr>
          <th>#</th><th>Empleado</th><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Notas</th><th>Acción</th>
        </tr></thead>
        <tbody id="turnBody"></tbody>
      </table>
    `;
    document.getElementById('btnAddTurno').addEventListener('click', ()=> openTurnoDialog());
    const fill = ()=> fillTurnos(
      document.getElementById('turnEmpFilter').value? Number(document.getElementById('turnEmpFilter').value):null,
      document.getElementById('turnWeek').value
    );
    document.getElementById('turnEmpFilter').addEventListener('change', fill);
    document.getElementById('turnWeek').addEventListener('change', fill);
    fill();
  }
  function fillTurnos(empId, weekStr){
    const tbody = document.getElementById('turnBody'); tbody.innerHTML='';
    let list = state.rrhh.turnos.slice().sort((a,b)=> a.fecha<b.fecha?1:-1);
    if(empId) list = list.filter(t=> t.empId===empId);
    if(weekStr){
      const [y, w] = weekStr.split('-W').map(Number);
      const d = new Date(y, 0, 1 + (w-1)*7);
      const start = new Date(d.getFullYear(), d.getMonth(), d.getDate() - (d.getDay()||7) + 1); // lunes
      const end = addDays(start, 6);
      list = list.filter(t=> between(parseISO(t.fecha), start, end));
    }
    list.forEach((t,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td>${empName(t.empId)}</td>
        <td>${t.fecha}</td>
        <td>${t.inicio}</td>
        <td>${t.fin}</td>
        <td>${t.notas||'—'}</td>
        <td style="display:flex; gap:6px; flex-wrap:wrap">
          <button class="btn ghost" onclick="editTurno(${t.id})">Editar</button>
          <button class="btn bad" onclick="deleteTurno(${t.id})">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function openTurnoDialog(item){
    const dlg = document.getElementById('dlgTurno');
    const form = document.getElementById('formTurno');
    const title = document.getElementById('dlgTurnoTitle');
    form.empId.innerHTML = empOptions(item?.empId || '');
    if(item){
      title.textContent='Editar turno';
      form.empId.value=item.empId; form.fecha.value=item.fecha; form.inicio.value=item.inicio; form.fin.value=item.fin; form.notas.value=item.notas||'';
    }else{
      title.textContent='Nuevo turno';
      form.reset(); form.fecha.value=todayISO(); form.inicio.value='09:00'; form.fin.value='18:00';
    }
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(form);
      const payload = {
        id: item? item.id : ++state.shiftSeq,
        empId: Number(fd.get('empId')),
        fecha: fd.get('fecha'),
        inicio: fd.get('inicio'),
        fin: fd.get('fin'),
        notas: (fd.get('notas')||'').trim()
      };
      if(!payload.empId){ alert('Selecciona un empleado'); return; }
      if(item){ state.rrhh.turnos = state.rrhh.turnos.map(t=> t.id===item.id? payload : t); }
      else { state.rrhh.turnos.push(payload); }
      saveState(); renderTurnos();
    }, {once:true});
  }
  function editTurno(id){ const t = state.rrhh.turnos.find(x=>x.id===id); if(t) openTurnoDialog(t); }
  function deleteTurno(id){
    if(!confirm('¿Eliminar turno?')) return;
    state.rrhh.turnos = state.rrhh.turnos.filter(t=> t.id!==id);
    saveState(); renderTurnos();
  }

  // =============================================================
  //  Evaluaciones
  // =============================================================
  function renderEvaluaciones(){
    const content = document.getElementById('rrhhContent');
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; align-items:center">
          <h3 style="margin:0">Evaluaciones</h3>
          <select id="evalEmpFilter" style="min-width:220px">${empOptions('')}</select>
          <span class="pill muted">Total: ${state.rrhh.evaluaciones.length}</span>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn ok" id="btnAddEval">Añadir</button>
        </div>
      </div>
      <table id="tblEvaluaciones">
        <thead><tr>
          <th>#</th><th>Empleado</th><th>Fecha</th><th>Puntaje</th><th>Comentarios</th><th>Acción</th>
        </tr></thead>
        <tbody id="evalBody"></tbody>
      </table>
    `;
    document.getElementById('btnAddEval').addEventListener('click', ()=> openEvalDialog());
    const filter = document.getElementById('evalEmpFilter');
    filter.addEventListener('change', ()=> fillEval(filter.value? Number(filter.value): null));
    fillEval(null);
  }
  function fillEval(empId){
    const tbody = document.getElementById('evalBody');
    tbody.innerHTML='';
    let list = state.rrhh.evaluaciones.slice().sort((a,b)=> a.fecha<b.fecha?1:-1);
    if(empId) list = list.filter(v=> v.empId===empId);
    list.forEach((v,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td>${empName(v.empId)}</td>
        <td>${v.fecha}</td>
        <td>${v.puntaje}</td>
        <td><details><summary>Ver</summary>${(v.comentarios||'').replaceAll('<','&lt;')}</details></td>
        <td style="display:flex; gap:6px; flex-wrap:wrap">
          <button class="btn ghost" onclick="editEval(${v.id})">Editar</button>
          <button class="btn bad" onclick="deleteEval(${v.id})">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  function openEvalDialog(item){
    const dlg = document.getElementById('dlgEval');
    const form = document.getElementById('formEval');
    const title = document.getElementById('dlgEvalTitle');
    form.empId.innerHTML = empOptions(item?.empId || '');
    if(item){
      title.textContent='Editar evaluación';
      form.empId.value=item.empId; form.fecha.value=item.fecha; form.puntaje.value=item.puntaje; form.comentarios.value=item.comentarios||'';
    }else{
      title.textContent='Nueva evaluación';
      form.reset(); form.fecha.value=todayISO(); form.puntaje.value=3;
    }
    dlg.showModal();

    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue!=='confirm') return;
      const fd = new FormData(form);
      const payload = {
        id: item? item.id : ++state.evalSeq,
        empId: Number(fd.get('empId')),
        fecha: fd.get('fecha'),
        puntaje: Number(fd.get('puntaje'))||0,
        comentarios: (fd.get('comentarios')||'').trim()
      };
      if(!payload.empId){ alert('Selecciona un empleado'); return; }
      if(item){ state.rrhh.evaluaciones = state.rrhh.evaluaciones.map(v=> v.id===item.id? payload : v); }
      else { state.rrhh.evaluaciones.push(payload); }
      saveState(); renderEvaluaciones();
    }, {once:true});
  }
  function editEval(id){ const v = state.rrhh.evaluaciones.find(x=>x.id===id); if(v) openEvalDialog(v); }
  function deleteEval(id){
    if(!confirm('¿Eliminar evaluación?')) return;
    state.rrhh.evaluaciones = state.rrhh.evaluaciones.filter(v=> v.id!==id);
    saveState(); renderEvaluaciones();
  }

  // =============================================================
  //  Organigrama (Canvas sencillo)
  // =============================================================
  function renderOrganigrama(){
    const content = document.getElementById('rrhhContent');
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
        <h3 style="margin:0">Organigrama</h3>
        <div class="muted">Se dibuja a partir del campo "Manager" de cada empleado.</div>
      </div>
      <div class="chart-wrap"><canvas id="orgCanvas" class="chart" width="1000" height="360"></canvas></div>
    `;
    drawOrgChart();
  }
  function buildOrgTree(){
    const nodes = state.rrhh.empleados.map(e=> ({...e, children:[]}));
    const map = new Map(nodes.map(n=> [n.id, n]));
    const roots = [];
    nodes.forEach(n=>{
      if(n.managerId && map.has(n.managerId)) map.get(n.managerId).children.push(n);
      else roots.push(n);
    });
    return roots;
  }
  function drawOrgChart(){
    const roots = buildOrgTree();
    const c = document.getElementById('orgCanvas'); if(!c) return;
    const ctx = c.getContext('2d'); const w=c.width, h=c.height;
    ctx.clearRect(0,0,w,h);
    const levelH = 90, boxW=180, boxH=40, hGap=30, vGap=50;
    ctx.font='12px system-ui';
    function measureWidth(node){ // ancho total de subárbol
      if(node.children.length===0) return boxW;
      return Math.max(boxW, node.children.map(measureWidth).reduce((a,b)=>a+b,0) + hGap*(node.children.length-1));
    }
    function drawNode(node, x, y){
      // caja
      ctx.fillStyle='rgba(61,214,208,.18)'; ctx.strokeStyle='rgba(61,214,208,.5)';
      ctx.fillRect(x, y, boxW, boxH); ctx.strokeRect(x, y, boxW, boxH);
      ctx.fillStyle='#cfe8ff'; ctx.fillText(node.nombre, x+8, y+16);
      ctx.fillStyle='#9fb3c8'; ctx.fillText(node.cargo||'', x+8, y+30);
      // hijos
      if(node.children.length){
        // línea vertical al centro inferior
        const cx = x + boxW/2; const y2 = y + boxH;
        ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.beginPath(); ctx.moveTo(cx, y2); ctx.lineTo(cx, y2+vGap/2); ctx.stroke();
        // ancho total y posición inicial
        const totalW = node.children.map(measureWidth).reduce((a,b)=>a+b,0) + hGap*(node.children.length-1);
        let startX = cx - totalW/2;
        node.children.forEach(ch=>{
          const chW = measureWidth(ch);
          const childX = startX;
          const childY = y + boxH + vGap;
          // conector horizontal y vertical
          ctx.beginPath();
          ctx.moveTo(cx, y + boxH + vGap/2);
          ctx.lineTo(childX + chW/2, y + boxH + vGap/2);
          ctx.lineTo(childX + chW/2, childY);
          ctx.stroke();
          drawNode(ch, childX + (chW - boxW)/2, childY);
          startX += chW + hGap;
        });
      }
    }
    // dibujar cada raíz
    let x = 20, y = 20;
    roots.forEach(r=>{
      const wTree = measureWidth(r);
      drawNode(r, x + (wTree - boxW)/2, y);
      x += wTree + 40;
    });
  }

  // =============================================================
  //  Onboarding (Checklist por empleado)
  // =============================================================
  function renderOnboarding(){
    const content = document.getElementById('rrhhContent');
    const firstEmp = state.rrhh.empleados[0]?.id || '';
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px">
        <div style="display:flex; gap:8px; align-items:center">
          <h3 style="margin:0">Onboarding</h3>
          <select id="obEmp" style="min-width:220px">${empOptions(firstEmp)}</select>
          <span class="pill muted" id="obCount">—</span>
        </div>
        <div style="display:flex; gap:8px">
          <input id="obNewText" placeholder="Nuevo ítem…" style="min-width:260px">
          <button class="btn ok" id="btnAddOB">Añadir</button>
        </div>
      </div>
      <table id="tblOnboarding">
        <thead><tr>
          <th>#</th><th>Hecho</th><th>Ítem</th><th>Acción</th>
        </tr></thead>
        <tbody id="obBody"></tbody>
      </table>
    `;
    document.getElementById('btnAddOB').addEventListener('click', addOBItem);
    document.getElementById('obEmp').addEventListener('change', ()=> fillOB());
    fillOB();
  }
  function addOBItem(){
    const empId = Number(document.getElementById('obEmp').value);
    const text = (document.getElementById('obNewText').value||'').trim();
    if(!empId){ alert('Selecciona un empleado'); return; }
    if(!text){ alert('Escribe un ítem'); return; }
    state.rrhh.onboarding.push({ id: ++state.todoSeq, empId, texto:text, done:false });
    document.getElementById('obNewText').value='';
    saveState(); fillOB();
  }
  function fillOB(){
    const empId = Number(document.getElementById('obEmp').value);
    const tbody = document.getElementById('obBody'); tbody.innerHTML='';
    const list = state.rrhh.onboarding.filter(o=> o.empId===empId);
    document.getElementById('obCount').textContent = `Total: ${list.length} · Pend: ${list.filter(x=>!x.done).length}`;
    list.forEach((o,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${String(i+1).padStart(2,'0')}</td>
        <td><input type="checkbox" ${o.done?'checked':''} data-ob="${o.id}"></td>
        <td contenteditable="true" data-obe="${o.id}" style="outline:none">${o.texto.replaceAll('<','&lt;')}</td>
        <td><button class="btn bad" onclick="deleteOB(${o.id})">Eliminar</button></td>
      `;
      tbody.appendChild(tr);
    });
    // bind toggles y edición inline
    tbody.querySelectorAll('input[type="checkbox"][data-ob]').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const id = Number(ch.dataset.ob);
        const it = state.rrhh.onboarding.find(x=>x.id===id); if(!it) return;
        it.done = ch.checked; saveState(); fillOB();
      });
    });
    tbody.querySelectorAll('[data-obe]').forEach(cell=>{
      cell.addEventListener('blur', ()=>{
        const id = Number(cell.dataset.obe);
        const it = state.rrhh.onboarding.find(x=>x.id===id); if(!it) return;
        it.texto = cell.textContent.trim(); saveState();
      });
    });
  }
  function deleteOB(id){
    if(!confirm('¿Eliminar ítem?')) return;
    state.rrhh.onboarding = state.rrhh.onboarding.filter(o=> o.id!==id);
    saveState(); fillOB();
  }

  // =============================================================
  //  Integración con router y arranque directo
  // =============================================================
  function renderRRHHRoute(){
    ensureRRHHLayout();
    rrhhBindTabs();
  }

  (function(){
    const _show = window.showRoute;
    window.showRoute = function(name){
      _show(name);
      if(name==='rrhh') renderRRHHRoute();
    }
  })();

  window.addEventListener('DOMContentLoaded', ()=>{
    const routeVisible = Array.from(document.querySelectorAll('.route')).find(r=> r.style.display!=='none');
    if(routeVisible && routeVisible.id==='route-rrhh'){ renderRRHHRoute(); }
  });

  // ========================= FIN BLOQUE 6 (RR.HH.) =========================
document.getElementById('saveAllBtn').addEventListener('click', function(){
  saveState();
  alert('¡Todos los datos han sido guardados de forma segura en este navegador!');
});



const toggleIcon = document.getElementById('toggleIcon');
const sidebarOverlay = document.getElementById('sidebarOverlay');
document.getElementById('toggleSidebar').addEventListener('click', function() {
  document.body.classList.toggle('sidebar-collapsed');
  toggleIcon.textContent = document.body.classList.contains('sidebar-collapsed') ? '⮞' : '⮜';
  // Mostrar/ocultar overlay
  sidebarOverlay.style.display = document.body.classList.contains('sidebar-collapsed') ? 'block' : 'none';
});
// Permite volver a expandir haciendo click fuera del sidebar
sidebarOverlay.addEventListener('click', function() {
  document.body.classList.remove('sidebar-collapsed');
  toggleIcon.textContent = '⮜';
  sidebarOverlay.style.display = 'none';
});


  </script>
  <!-- Parche activador RR.HH. (colócalo al final del <script>) -->
<script>
(function(){
  function safeRenderRRHH(){
    if (typeof renderRRHHRoute === 'function') {
      try { renderRRHHRoute(); } catch(e){ console.error('RRHH init error:', e); }
    } else {
      console.warn('renderRRHHRoute no está definido aún.');
    }
  }

  // Re-hook del router (idempotente)
  if (typeof window.showRoute === 'function') {
    const _show = window.showRoute;
    window.showRoute = function(name){
      _show(name);
      if (name === 'rrhh') safeRenderRRHH();
    };
  }

  // Forzar render al primer clic en el botón de RR.HH.
  window.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('#sidebar [data-route="rrhh"]');
    if (btn && !btn.dataset.rrhhBound) {
      btn.dataset.rrhhBound = '1';
      btn.addEventListener('click', () => safeRenderRRHH(), { once: true });
    }
    

    // Si abres directo la ruta RR.HH. (por anclaje o recarga)
    const routeVisible = Array.from(document.querySelectorAll('.route'))
      .find(r => r.style.display !== 'none');
    if (routeVisible && routeVisible.id === 'route-rrhh') safeRenderRRHH();
  });
})();

// Toggle Sidebar
document.getElementById('toggleSidebar').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('collapsed');
});
</script>
<script>
document.querySelectorAll('dialog').forEach(dlg => {
  dlg.querySelectorAll('button[value="cancel"]').forEach(btn => {
    btn.addEventListener('click', () => dlg.close('cancel'));
  });
});
document.getElementById('backupBtn').addEventListener('click', function(){
  const data = localStorage.getItem('microerp_repuestos_v1');
  if(!data) return alert('No hay datos para exportar.');
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'microerp-backup-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('restoreBtn').addEventListener('click', function(){
  document.getElementById('restoreFile').click();
});
document.getElementById('restoreFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    try {
      const data = JSON.parse(ev.target.result);
      if(!data || typeof data !== 'object') throw new Error('Archivo inválido');
      localStorage.setItem('microerp_repuestos_v1', JSON.stringify(data));
      alert('¡Copia de seguridad restaurada! Recarga la página para ver los cambios.');
    } catch(err) {
      alert('Error al importar la copia de seguridad: ' + err.message);
    }
    e.target.value = '';
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
